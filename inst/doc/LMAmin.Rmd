---
title: "A minimum LMA in TROLL ?"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
csl: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/csl/mee.csl
bibliography: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(reshape2)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
cores <- 15
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```

# Issue

```{r mm Results, fig.height=12, fig.width=12}
# Load stack
load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Run1.Rdata')

# Data prep & check
datal <- extractData(mm)
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)

# Evidence
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
species$sp = row.names(species)
species$LL <- 1.5+(7.18+3.03*log10(species$LMA*0.0001))^10
species <- species[names(mm@layers),]
species$agemax <- as.numeric(lapply(mm@layers, function(layer) max(layer@final_pattern$age)))
rm(mm, datal)
```

In order to study biodiversity effect on disturbance we decied to use @Loreau2001 partitionning. To do so we needed to generate a monoculture forest for each species present in community assemblages that we wanted to test. But monoculture simulations without disturbance over 500 years shown some strange results for low species with low leaf mass per area (LMA). More specifically some monoculture show really low aboveground biomass (AGB) and basal area (BA, see figure 1) and a really small maximum age in the final stand (see figure 2).

```{r AGB}
g1 <- ggplot(data, aes(x = ba, y = agb, colour = sim)) +
  geom_point() + guides(colour = F) +
  xlab('Basal area (m2/ha)') + ylab('Aboveground biomass (kgC/ha)')
(g1 <- plotly_POST(ggplotly(g1), filename="p1")) ; rm(g1, data)
```

Figure 1: Aboveground biomass and Basal area after 500 years. *Colour represents the species present in the monoculture simulated with TROLL over 500 years.*

```{r Agemax}
g1 <- ggplot(species, aes(x = LMA, y = agemax, col = LL, label = sp)) + geom_point() +
  xlab('Leaf Mass per Area (g/m2)') + ylab('Age maximum (years)') +
  scale_color_continuous(name = 'Log10 leaf lifespan', trans = 'log10')
(p1 <- plotly_POST(ggplotly(g1), filename="g1")) ; rm(g1, p1, species)
```

Figure 2: Age maximum and Leaf Mass per Area (LMA) after 500 years. *Colour represents the leaf lifespan present in the monoculture simulated with TROLL over 500 years.*

# Mathematical solution

<span style="color:red"> In subsequent demonstration assumptions will be made in red. </span>

## Abiotic environment

```{r Env}
Env <- data.frame(maxIrradiance = c(719.7763,	765.6474679,	769.9658806,	794.82337,	717.8013194,
                                    795.2024929,	791.62932,	797.9236677,	874.5701367,
                                    857.4397219, 858.60655323, 779.2854645),
                  Tyear = c(24.64982014,	24.60624211,	24.49933474,	24.96279395,	24.88365139,
                            24.87594184,	24.98313802,	25.68910135,	26.58033805,	26.98619405,
                            25.87259696, 25.16530008),
                  VPD = c(0.306379098,	0.340328739,	0.303167936,	0.375753098,	0.24826003,
                          0.284006455,	0.335374559,	0.528268788,	0.822016731,	0.860172905,
                          0.59377794, 0.438773096),
                  nightmeanT = c(23.22247,	23.15235,	23.21073,	23.35492,	23.58619,	23.29334,
                                 23.35780, 23.66990, 24.09092, 24.55815, 23.71159, 23.34976))
```

Currently abiotic environment is varying among month. What is interesting us is the minimal environement values for which tree with low $LMA$ will stop to assimilate carbohydrates. So for further equations we will use month with minimal maximum irradiance ($Wmax_{min}$), Januar with following maximum irradiance ($Wmax_{Jan}$), temperature ($T_{Jan}$) and VPD ($VPD_{Jan}$): `r Env[1,]`.

For each voxel the leaf area density $dens$ depend on total leaf area ($LA$) and crown volume ($crowvolume$) and is inititalized to $dens_0 = 0.8$. Then $LAI[h]$ from a $h$ layer of crown is computed by summing each voxel with leaf from the crown layer. We finally obtain $PPFD$ from a layer with following formulae:
$$dens_{t-1} = \frac{LA_{t-1}}{crownvolume_{t-1}}$$
$$PPFD[h] = Wmax*e^{-K_{light}*LAI[h]},~~K_{light} = 0.9$$

<span style="color:red"> If we look at leaf density $dens$ in simulations, we can't simplify it because it seems to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 3). Still we can assume that issues appear when $crownvolume > LA$ implying $dens < 1$.</span>

```{r dens, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
data <- melt(site[c('iter', 'species', 'LA','crownvolume','dens')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y') ; rm(site, data)
```

Figure 3: Leaf area ($LA$), crown volume ($crownvolume$) and leaf density ($dens$) for a low LMA species (Symphonia sp 1) and a normal LMA species (Dicorynia guianensis).

And if we assume a crown depth of one meter:
$$PPFD[h] = Wmax*e^{-K_{light}*dens_{t-1}*CrownDepth},~~K_{light} = 0.9$$
$$crownvolume = \pi*(CrownRadius*LH)^2*CrownDepth*LV,~~LH=1,~~LV=1$$
$$PPFD[h]_{t} = Wmax*e^{-K_{light}*\frac{LA_{t-1}}{\pi*CrownRadius_{t-1}^2}},~~K_{light} = 0.9, ~~ \pi = 3.14$$

<span style="color:red"> If we look at $PPFD$ in simulations, we can't simplify it because it seems to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 4). Still we can assume that issues appear when $CrownRadius$ is growing faster than leaf area ($LA$).</span>

```{r PPFD, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
site$kPPFD <- site$PPFD/1000
data <- melt(site[c('iter', 'species', 'LA','CR', 'kPPFD')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y') ; rm(data)
```

Figure 4: Leaf area ($LA$), crown radius ($CrownRadius$) and PPFD ($PPFD$) for a low LMA species (Symphonia sp 1) and a normal LMA species (Dicorynia guianensis).

So in January and for a crown depth of 1, we get:
$$PPFD_{Jan,t}[h] = `r round(Env[1,1],2)`*e^{-`r round(0.9/3.14,2)`*\frac{LA_{t-1}}{CrownDepth_{t-1}}}$$

<span style="color:red"> Still PPFD vary relatively few in TROLL simulations (see table 1). And what is interesting us is minimal values that will play more on low LMA species. So for further numeric applicaitons we will use $PPFD_{min} = 1204$. </span>

Table 1: PPFD ($PPFD$) for a low LMA species (Symphonia sp 1) and a normal LMA species (Dicorynia guianensis).

```{r PPFD val}
kable(t(data.frame(unclass(summary(site$PPFD)))), row.names = F)
PPFD <- min(site$PPFD) ; rm(site)
```

## Photosynthesis

We will calculate leaf assimilation $A$:

We got:
$$denTB = \frac{1}{R*10^-3*(T + 273.15)}, ~~ R = 8.314 $$
$$vCfactor = \frac{T - 25}{298*R*10^-3*(273 + T)}, ~~ R = 8.314$$
$$Kc_{T} = 404*e^{59.36*vCfactor}$$
$$Ko_{T} = 248*e^{-35.94*vCfactor}$$
$$Km_{T} = \frac{Kc_{T}}{Cair}*(1+\frac{210}{Ko_{T}}), ~~ Cair = 360$$
With January values we obtain:

```{r KmT}
denTB <- function(Temp, R = 8.314) 1/(R*(10^-3)*(Temp + 273.15))
vCfactor <- function(Temp, R = 8.314) (Temp - 25)/((298*R*(10^-3)*(273 + Temp)))
KcT <- function(Temp, R = 8.314) 404*exp((59.36*vCfactor(Temp, R)))
KoT <- function(Temp, R = 8.314) 248*exp((-35.94*vCfactor(Temp, R)))
KmT <- function(Temp = Env[1,2], R = 8.314, Cair = 360) (KcT(Temp, R)/Cair)*(1+(210/KoT(Temp, R)))
```

$$Km_{Jan} = `r round(KmT(),2)`$$

In addition:
$$Vcmax = LMA*10^{min(-1.56 + 0.43*log_{10}(10^4*Nmass) + 0.37*log_{10}(\frac{10^4}{LMA})~;~-0.80 + 0.45*log_{10}(10^4*Pmass) + 0.25*log_{10}(\frac{10^4}{LMA}))}$$
$$Jmax = LMA*10^{min(-1.50 + 0.41*log_{10}(10^4*Nmass) + 0.45*log_{10}(\frac{10^4}{LMA})~;~-0.74 + 0.44*log_{10}(10^4*Pmass) + 0.32*log_{10}(\frac{10^4}{LMA}))}$$
We can simplfy in:
$$Vcmax = LMA*10^{min(1.64 + 0.43*log_{10}(Nmass) - 0.37*log_{10}(LMA)~;~2.00 + 0.45*log_{10}(Pmass) - 0.25*log_{10}(LMA))}$$
$$Jmax = LMA*10^{min(1.94 + 0.41*log_{10}(Nmass) - 0.45*log_{10}(LMA)~;~2.30 + 0.44*log_{10}(Pmass) - 0.32*log_{10}(LMA))}$$

<span style="color:red"> Looking at species functional traits we can see that we will mainly use $Vcmax$ computed with $Nmass$ and $Jmax$ with $Pmass$ (see figure 5). This assumption will only become false with our data set for $Vcmax$ when $LMA$ is above 150. </span>

```{r Vcmax, fig.height=4}
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA', 'Nmass', 'Pmass')]
Vcmax <- function(sp){
  LMA <- sp[1] ; Nmass <- sp[2] ; Pmass <- sp[3]
  VcmaxN <- LMA*(1.64 + 0.43*log10(Nmass) - 0.37*log10(LMA))^10
  VcmaxP <- LMA*(2.00 + 0.45*log10(Pmass) - 0.25*log10(LMA))^10
  return(c(VcmaxN, VcmaxP))
} 
Jmax <- function(sp){
  LMA <- sp[1] ; Nmass <- sp[2] ; Pmass <- sp[3]
  JmaxN <- LMA*(1.94 + 0.41*log10(Nmass) - 0.45*log10(LMA))^10
  JmaxP <- LMA*(2.30 + 0.44*log10(Pmass) - 0.32*log10(LMA))^10
  return(c(JmaxN, JmaxP))
}
species <- cbind(species, t(apply(species, 1, Vcmax)), t(apply(species, 1, Jmax)))
names(species)[4:7] <- c('VcmaxN', 'VcmaxP', 'JmaxN', 'JmaxP')
data <- melt(species[c('LMA', 'VcmaxN', 'VcmaxP', 'JmaxN', 'JmaxP')], id = 'LMA')
ggplot(data, aes(x = LMA, y = log(value), color = variable)) + geom_point() + geom_line() ; rm(data, species, Vcmax, Jmax)
```

Figure 5: Vcmax and Jmax computed with Nmass or Pmass.

We can simplfy in:
$$Vcmax = LMA*10^{1.64 + 0.43*log_{10}(Nmass) - 0.37*log_{10}(LMA)}$$
$$Jmax = LMA*10^{2.30 + 0.44*log_{10}(Pmass) - 0.32*log_{10}(LMA)}$$
<span style="color:red"> If we use allometries from @wright_worldwide_2004, we can replace $Nmass$ and $Pmass$ by $LMA$ in equation ($\phi$): </span>
$$log_{10}(Nmass*10^4) = 1.4192 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass*10^4) = 0.8298 - 0.9040*log_{10}(LMA)$$
$$log_{10}(Nmass) = -2.5808 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass) = -3.1702 - 0.9040*log_{10}(LMA)$$
$$Vcmax = LMA*10^{0.53 - 1.48*log_{10}(LMA)}$$
$$Jmax = LMA*10^{0.90 - 1.71*log_{10}(LMA)}$$
In addition:
$$Jmax_{T} = Jmax*e^{17.57-43.54*denTB}$$
$$Vcmax_{T} = Vcmax*e^{26.35-65.33*denTB}$$
$$\gamma_{T} = \frac{37}{Cair}*e^{vCfactor*23.4},~~Cair = 360$$
$$fci = \frac{g1}{g1 + \sqrt{VPD}}, ~~ g1 = 3.77$$
$$I = 4 * \phi * PPFD, ~~ \phi = 0.06$$
$$J = \frac{0.5}{\theta} * (I + Jmax_{T} - \sqrt{(Jmax_{T} + I)^2 - 4*\theta*Jmax_{T}*I}), ~~ \theta = 0.7$$
$$A = min(\frac{Vcmax_T*(fci - \gamma_T)}{fci + Km_T} ~;~ \frac{0.25*J*(fci - \gamma_T)}{fci + 2*\gamma_T})$$

<span style="color:red"> It appears that for our range of varition on LMA A2 will be always smaller than A1 (see figure 6). Consequently we get: </span>
$$A = \frac{J}{4}*\frac{fci - \gamma_T}{fci + 2*\gamma_T} $$

```{r A, fig.height=4}
# Equations
Vmax <- function(LMA) LMA*10^(0.53 - 1.48 *log10(LMA))
Jmax <- function(LMA) LMA*10^(0.90 - 1.71 *log10(LMA))
JmaxT <- function(LMA, Temp = Env[1,2]) Jmax(LMA)*exp((17.57-43.54*denTB(Temp)))
VcmaxT <- function(LMA, Temp = Env[1,2]) Vmax(LMA)*exp((26.35-65.33*denTB(Temp)))
GammaT <- function(Temp = Env[1,2], Cair = 360) (37/Cair)*exp((vCfactor(Temp)*23.4))
fci <- function(VPD = Env[1,3], g1 = 3.77) g1 / (g1 + sqrt(VPD))
I <- function(PPFD = 1204.47, phi = 0.06) 4 * phi * PPFD
J <- function(LMA, theta = 0.7) 
  (0.5/theta)*(I()+JmaxT(LMA)-sqrt((JmaxT(LMA)+I())^2-4*theta*JmaxT(LMA)*I()))
A1 <- function(LMA) 
  (VcmaxT(LMA)*(fci()-GammaT()))/(fci()+KmT())
A2 <- function(LMA) 
  (0.25*J(LMA)*(fci()-GammaT()))/(fci()+2*GammaT())
# Graph
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA')]
species$A1 <- sapply(species$LMA, A1)
species$A2 <- sapply(species$LMA, A2)
data <- melt(species, id = 'LMA')
ggplot(data, aes(x = LMA, y = value, color = variable)) + geom_point() + geom_line() ; rm(species, data)
```

Figure 6: A in function of observed LMA in species dataset.

## Autotrophic respiration

Autotrophic respiration in TROLL simulations is partitioned between stem and roots and canopy. 

### Stem rspiration

Stem respiration is calculated as follow:

$$Rstem = 39.6*sapthick*\pi*(dbh-sapthick)*(height-CrownDepth)*378.7*t*e^{\frac{T-25}{10*log(2)}}, ~~ t \in |0,1|,~~\pi=3.14$$
$sapthick$ depend on $dbh$:
$$sapthick=0.04,~~dbh \geq 0.08$$
$$sapthick=\frac{dbh}{2},~~dbh < 0.08$$
$height$ depend on $dbh$:
$$height = hmax * \frac{dbh}{dbh + ah}$$
And $CrownDepth$ depend on $height$:
$$CrownDepth = 0.17 + 0.13*height, \forall height \leq 5.0$$
$$CrownDepth = -0.48+0.26*height, \forall height > 5.0$$

<span style="color:red"> In our cases of early-dying tree from low $LMA$ species, tree did not reached high $dbh$ (see figure 7). So we can consider $sapthick$ equation with $dbh < 0.08$. Similarly because $height$ is an allometry of $dbh$, in our cases of interest, $height$ did not reached $5.0$ allowing us to consider only second equation of $CrownDepth$.</span>

```{r sapthick, fig.height=4}
load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Run1.Rdata')
plot(mm@layers$Symphonia_sp.1, what = 'dbh', ggplot2 = T) ; rm(mm)
Rstem1 <- function(Temp = Env[1,2], pi = 3.14)
  39.6*(pi/4)*378.7*exp(((Temp-25)/(10*log(2))))
```

Figure 7: Diameter at breast height ($dbh$) for a low LMA species (Symphonia sp 1).

So we got following formulae:
$$Rstem = 39.6*sapthick*\pi*(dbh-sapthick)*(height-CrownDepth)*378.7*t*e^{\frac{T-25}{10*log(2)}}, ~~ t \in |0,1|,~~\pi=3.14$$
$$sapthick=\frac{dbh}{2}$$
$$height = hmax * \frac{dbh}{dbh + ah}$$
$$CrownDepth = 0.17 + 0.13*height$$
<span style="color:red"> Resulting in following formula with January values:</span>
$$Rstem_{Jan} = `r round(Rstem1(),2)`*dbh^2*(-0.17+0.13*hmax*\frac{dbh}{dbh + ah})*t, ~~ t \in |0,1|$$
<span style="color:red"> Finally we can use mean values of hmax and ah (resp. 50.06 and 0.323), and we obtain:</span>
$$Rstem_{Jan} = `r round(Rstem1(),2)`*dbh^2*(-0.17+6.5078*\frac{dbh}{dbh + 0.323})*t, ~~ t \in |0,1|$$

### Canopy respiration

Canopy respiration is caluclated with following formulae:
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3*t, ~~ t \in |1, 0|$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3*t, ~~ t \in |0,1|$$

$Rdark$ is a species traits computed from functional traits:
$$Rdark = LMA*(8.5341-130.6*Nmass-567.0*Pmass-0.0137*LMA+11.1*Vcmaxm+187600*Nmass*Pmass)*0.001$$
<span style="color:red"> If we use allometries from @wright_worldwide_2004, we can replace $Nmass$ and $Pmass$ by $LMA$ in equation ($\phi$): </span>
$$log_{10}(Nmass) = 5.4192 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass) = 4.8298 - 0.9040*log_{10}(LMA)$$
$$Vcmax_m = 10^{0.53 - 1.48*log_{10}(LMA)}$$
$$Jmax_m = 10^{0.90 - 1.71*log_{10}(LMA)}$$
$$Rdark = f(LMA)$$

<span style="color:red"> If we look at autotrophic respiration $R$ in simulations, we can't simplify it because it seems to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 8). Still we can assume that issues appear when respiration in stem ($Rstem$) is reaching respiration in canopy during day ($Rday$).</span>

```{r R, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
site$kPPFD <- site$PPFD/1000
data <- melt(site[c('iter', 'species', 'Rstem','Rday', 'Rnight')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y')
```

Figure 8: Stem respiration ($Rstem$), Canopy respiration during day ($Rday$) and night ($Rnight$) for a low LMA species (Symphonia sp 1) and a normal LMA species (Dicorynia guianensis).

## Net carbon uptake

Net carbon uptake formulae are linking photosynthesis $A$ with equation $\phi$ to respiration equations:
$$GPP = A * \frac{LA_y + 2*LA_m + LA_o}{2} * 189.3 * t , ~~ t \in |0,1|$$
$$NPP = \frac{3}{4}*(GPP - \frac{3}{2}*(Rday+Rnight+Rstem)) $$

<span style="color:red"> If we look at growth and net primary production (resp. $GPP$, $NPP$) and different components of autotrophic respirations, we can see that primary productions are greatly correlated ($r = 0.99$, see figure 9). So taking into account equations, we can assume that respirations are too small compared to $GPP$ variations and can be assumed as constant, excpet for cases that interest us for low LMA species: </span>

```{r GPP, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
data <- melt(site[c('iter', 'species', 'GPP', 'NPP', 'Rstem','Rday', 'Rnight')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y')
```

Figure 9: Growth and net primary production (resp. $GPP$, $NPP$), and respiration in stem ($Rstem$), canopy during day ($Rday$), and canopy during night ($Rnight$) for a low LMA species (Symphonia sp 1) and a normal LMA species (Dicorynia guianensis).

## Tree growth

### Stem

Growth of stem is calculated with following equations:
$$volume = \frac{2.0*NPP}{wsg} * fallocwood * 10^{-6},~~fallocwood = 0.35$$
$$ddbh = \frac{volume}{0.559*dbh*height\frac{3-dbh}{dbh+ah}}$$
$$dbh_{t+1} = dbh + ddbh$$
<span style="color:red"> If we use mean values of wsg, hmax and ah (resp. 0.645, 50.06 and 0.323) and height allometry from dbh, we obtain:</span>
$$ddbh = 3.878*10^{-8}*\frac{NPP}{\frac{(3-dbh)*dbh^2}{(dbh+0.5)^2}}$$

### Leaves

Growth of leaves is calculated with following equations:
$$flush = \frac{2.0*NPP*falloccanopy*0.68}{LMA},~~falloccanopy = 0.30$$
$$new_m = \frac{LA_y}{t_y},~~t_y=1$$
$$new_o = \frac{LA_m}{t_m}$$
$$litter= \frac{LA_o}{t_o}$$
$$t_m = \frac{leaflifespan}{3}$$
$$t_o = leaflifespan - t_m - t_y,~~t_y=1$$
$$leaflifespan = 1.5+10^{7.18+3.03*log_{10}(LMA*10^-4)} = f(LMA)$$
$$dLA_y = flush - new_m$$
$$dLA_m = new_m - new_o$$
$$dLA_o = new_o - litter$$
$$dLA = dLA_y + dLA_m + dLA_o$$
$$LA_{t+1} = LA + dLA$$
We can summarize $dLA$ in:
$$dLA = \frac{0.408*NPP}{LMA} - \frac{3}{2*leaflifespan-3}*LA_o$$

## Resolution

### Equations

<span style="color:red"> If we place ourselves at equilibrium with $LA_t = LA_e$ and $dLA = 0$, we also have $LA_{y,t} = LA_{y,e}$, $LA_{m,t} = LA_{m,e}$, and $LA_{o,t} = LA_{o,e}$, resulting in: </span>
$$LA_{y,e} = LA_{y,e} + dLA_{y,e}$$
$$LA_{y,e} = LA_{y,e} + flush - new_m$$
$$LA_{y,e} = LA_{y,e} + flush - LA_{y,e}$$
$$LA_{y,e} = flush$$
$$LA_{m,e} = LA_{m,e} + dLA_{m,e}$$
$$LA_{m,e} = LA_{m,e} + new_m - new_o$$
$$LA_{m,e} = LA_{m,e} + \frac{LA_{y,e}}{t_y} - \frac{LA_{m,e}}{t_m}$$
$$LA_{m,e} = LA_{m,e} + \frac{LA_{y,e}}{t_y} - \frac{LA_{m,e}}{t_m}$$
$$LA_{m,e} = \frac{flush*leaflifespan}{3}$$
$$LA_{o,e} = LA_{o,e} + dLA_{o,e}$$
$$LA_{o,e} = LA_{o,e} + new_o - litter$$
$$LA_{o,e} = LA_{o,e} + \frac{LA_{m,e}}{t_m} - \frac{LA_{o,e}}{t_o}$$
$$LA_{o,e} = \frac{t_o}{t_m} * LA_{m,e}$$
$$LA_{o,e} = \frac{t_o}{t_m} * LA_{m,e}$$
$$LA_{o,e} = \frac{2*leaflifespan-3}{leaflifespan} * \frac{flush*leaflifespan}{3}$$
$$LA_{o,e} = \frac{2*leaflifespan-3}{3} * flush$$
If we reintroduce $GPP$ formula from carbon uptake at equlibirum, we get:
$$GPP_e = A * \frac{LA_{y,e} + 2*LA_{m,e} + LA_{o,e}}{2} * 189.3, ~~if~ t=1$$
$$GPP_e = A * \frac{flush + 2*\frac{flush*leaflifespan}{3} + \frac{2*leaflifespan-3}{3} * flush}{2} * 189.3$$
$$GPP_e = 189.3 * A * flush * \frac{2*leaflifespan}{3}$$
Consequently we can obtain $NPP$ equation at equilibrium:
$$NPP_e = \frac{3}{4}*(GPP_e - \frac{3}{2}*(Rday+Rnight+Rstem)) $$
$$Rstem = \frac{2}{3}*GPP_e - \frac{8}{9}*NPP_e -Rday - Rnight $$
$Rstem$ depend on $dbh$ whereas $GPP$, $NPP$, $Rday$ and $Rnight$ depend on $LMA$. Consequently we have a maximum value of $dbh$ for which we reach an equilibrium and stop to produce leaves depending on species LMA. We can calculate it with following equations for left member:
$$flush = 0.408*\frac{NPP}{LMA}$$
$$GPP_e = 189.3 * A * flush * \frac{2*leaflifespan}{3}$$
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*189.3*flush*\frac{2*leaflifespan}{3}$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*189.3*flush*\frac{2*leaflifespan}{3}$$
Consequently we get:
$$Rstem = flush * f(LMA) = NPP * f(LMA)$$
$$Rstem = `r round(Rstem1(),2)`*dbh^2*(-0.17+6.5078*\frac{dbh}{dbh + 0.323})$$

### Graphic

```{r graph, fig.height=4}
rm(data, site, species)
# Right member of equation
A <- function(LMA) A2(LMA)
Nmass <- function(LMA) 10^(-2.58-0.59*log10(LMA))
Pmass <- function(LMA) 10^(-3.17-0.90*log10(LMA))
Vcmaxm <- function(LMA) 10^(0.53-1.48*log10(LMA))
Jmaxm <- function(LMA) 10^(0.90-1.71*log10(LMA))
Rdark <- function(LMA) LMA*(8.5341-130.6*Nmass(LMA)-567.0*Pmass(LMA)-0.0137*LMA+11.1*Vcmaxm(LMA)+187600*Nmass(LMA)*Pmass(LMA))*0.001 
LL <- function(LMA, method = 'Reich'){ 
  if(method == 'Wright')
    return(0.5+10^(-2.509+1.71*log10(LMA)))
  if(method == 'Reich')  
    return(1.5+10^(7.18+3.03*log10(LMA*0.0001)))}
GPP <- function(LMA, method = 'Reich') 
  189.3*A(LMA)*2*LL(LMA, method)/3*0.408/LMA
Rmb <- function(Temp) 
  exp(((Temp - 25)*0.1*log(3.09-0.0215*(25+Temp))))
Rday <- function(LMA, Temp = Env[1,2], method = 'Reich')
  Rdark(LMA)*Rmb(Temp)*0.40*189.3*2*LL(LMA, method)/3*0.408/LMA
Rnight <- function(LMA, Temp = Env[1,4], method = 'Reich') 
  Rdark(LMA)*Rmb(Temp)*189.3*2*LL(LMA, method)/3 *0.408/LMA
Rstem_LMA <- function(LMA, method = 'Reich') (2/3)*GPP(LMA, method)-(8/9)-Rday(LMA, method = method)-Rnight(LMA, method = method)
# Left member of equation
Rstem_dbh <- function(dbh)
  Rstem1()*dbh^2*(-0.17+6.5078*(dbh/(dbh + 0.232)))
# Getting dbh
Rstem <- function(dbh, LMA, NPP, method = 'Reich') Rstem_dbh(dbh) - NPP * Rstem_LMA(LMA, method)
get_dbh <- function(LMA, NPP, method = 'Reich'){
  FUN <- function(x) Rstem(x, LMA, NPP, method)
  optimize(FUN, c(0,2))$objective
}
NPP <- c(0.01, 0.1, 10, 100)
method <- c('Reich', 'Wright')
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA', 'dmax')]
species$species <- row.names(species)
speciesR <- cbind(species,
                 sapply(NPP, function(NPP) sapply(species$LMA, function(LMA) get_dbh(LMA, NPP, 'Reich'))))
speciesR$method <- 'Reich'
speciesW <- cbind(species,
                 sapply(NPP, function(NPP) sapply(species$LMA, function(LMA) get_dbh(LMA, NPP, 'Wright'))))
speciesW$method <- 'Wright'
species <- rbind(speciesR, speciesW) ; rm(speciesR, speciesW)
names(species)[-c(1:3,8)] <- paste('NPP',NPP)
data <- melt(species, id = c('species', 'LMA', 'method'))
g <- ggplot(data, aes(x = LMA, y = value, color = variable, shape = method, label = species)) + 
  geom_point() + geom_line() +scale_y_log10() ; g
# ggplotly(g)
```

Figure 10: Graphic resolution of the problem. *Maximum $dbh$ for a given level of net primary production ($NPP$) after which respiration cost is too high and provoke stop in leaf area ($LA$) increase resulting in death of the tree. Leaflifespan is calculated either with Reich or Wright allometry (currently TROLL is running with Reich allometry).*

# Leaflifespan allometry

Leaflifespan is currently computed from cite Reich allometry. We suggest to find a better value with @wright_worldwide_2004 GLOPNET dataset. First we can clearly see that allometry seems to greatly change between biomes (see figure 11).

```{r LL}
rm(list = ls()) ; invisible(gc())
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/LES.csv", skip = 10)
data <- LES[c('BIOME', 'Species', 'log.LL', 'log.LMA')]
data <- data[-which(is.na(data$log.LL)),]
data$LL <- 10^data$log.LL
data$LMA <- 10^data$log.LMA
g <- ggplot(data, aes(x = log.LMA, y = log.LL, colour = BIOME, label = Species))
g + geom_point() + geom_smooth(method = 'lm') + facet_wrap(~ BIOME)
```

Figure 11: Leaf mass per area (LMA) and leaflifespan (LL). *Leaf mass per area (LMA) and leaflifespan (LL) are taken in GLOPTNET dataset from @wright_worldwide_2004 with a linear regression by biome.*

# References
