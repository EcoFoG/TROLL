---
title: "A minimum LMA in TROLL ?"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
  html_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(reshape2)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
cores <- 15
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```

# Issue

```{r mm Results}
# Load stack
load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Run1.Rdata')

# Data prep & check
datal <- extractData(mm)
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)

# Evidence
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax', 'ah')]
species$sp = row.names(species)
species$LL <- 0.5+10^(-2.509+1.71*log10(species$LMA))
species <- species[names(mm@layers),]
species$agemax <- as.numeric(lapply(mm@layers, function(layer) 
  max(layer@final_pattern$age)))
species$dbhmax <- as.numeric(lapply(mm@layers, function(layer) 
  max(layer@final_pattern$dbh)))
species$inf <- as.factor(species$dbhmax < species$dmax)
rm(mm, datal)
```

In order to study biodiversity effect on disturbance we decied to use @Loreau2001 partitionning. To do so we needed to generate a monoculture forest for each species present in community assemblages that we wanted to test. But monoculture simulations without disturbance over 500 years showed some strange results for species with low leaf mass per area (LMA). More specifically monocultures with low LMA species showed unrealistically low aboveground biomass (AGB) and basal area (BA, see figure 1). Moreover in monocultures with low LMA species tree reached unrealistically small maximal age and diameter at breast height (dbh) in the final stand (see figure 2), in a nutshell tree were dying particularly young and small.

```{r AGB}
g1 <- ggplot(data, aes(x = ba, y = agb, colour = sim)) +
  geom_point() + guides(colour = F) +
  xlab('Basal area (m2/ha)') + ylab('Aboveground biomass (kgC/ha)')
# (g1 <- plotly_POST(ggplotly(g1), filename="p1"))
g1 ; rm(g1, data)
```

Figure 1: Aboveground biomass and Basal area after 500 years for monoculture stands. *Colour represents the species present in the monoculture simulated with TROLL over 500 years.*

```{r Agemax}
g1 <- ggplot(species, aes(x = LMA, y = agemax, col = LL, label = sp)) + geom_point() +
  xlab('Leaf Mass per Area (LMA in g/m2)') + ylab('Age maximum (years)') +
  scale_color_continuous(name = 'Log10 leaf\nlifespan\n(LL in months)', trans = 'log10')
# (p1 <- plotly_POST(ggplotly(g1), filename="g1")) ; rm(g1, p1, species)
g2 <- ggplot(species, aes(x = LMA, y = dbhmax, col = inf, label = sp)) + geom_point() +
  xlab('Leaf Mass per Area (LMA in g/m2)') + ylab('dbh maximum (m)') +
  scale_color_discrete(name = 'dbh max\ninferior to dmax')

g3 <- ggplot(species, aes(x = LMA, y = hmax, col = inf, label = sp)) + geom_point() +
  xlab('Leaf Mass per Area (LMA in g/m2)') + ylab('dbh maximum (m)') +
  scale_color_discrete(name = 'dbh max\ninferior to dmax')


plot_grid(g1, g2, labels = c('Age', 'dbh'), nrow = 2) ; rm(g1, g2, species)
```

Figure 2: Age, dbh maximum and Leaf Mass per Area (LMA) after 500 years of monoculture. *Colour in Age figure represents the leaf lifespan of the species present in the monoculture simulated with TROLL over 500 years. Whereas colour in dbh plot is red if maximum dbh found in the stand is superior to functional trait maximum diameter at breast height (resp. blue if not).*

# Mathematical solution

In subsequent demonstration assumptions will be made in **bold**.

## Abiotic environment

```{r Env}
Env <- data.frame(maxIrradiance = c(719.7763,	765.6474679,	769.9658806,	794.82337,	717.8013194,
                                    795.2024929,	791.62932,	797.9236677,	874.5701367,
                                    857.4397219, 858.60655323, 779.2854645),
                  Tyear = c(24.64982014,	24.60624211,	24.49933474,	24.96279395,	24.88365139,
                            24.87594184,	24.98313802,	25.68910135,	26.58033805,	26.98619405,
                            25.87259696, 25.16530008),
                  VPD = c(0.306379098,	0.340328739,	0.303167936,	0.375753098,	0.24826003,
                          0.284006455,	0.335374559,	0.528268788,	0.822016731,	0.860172905,
                          0.59377794, 0.438773096),
                  nightmeanT = c(23.22247,	23.15235,	23.21073,	23.35492,	23.58619,	23.29334,
                                 23.35780, 23.66990, 24.09092, 24.55815, 23.71159, 23.34976))
```

Currently abiotic environment is varying among month. We are interested in the minimal environement values for which trees with low $LMA$ will stop assimilating carbohydrates. So for subsequent numeric applications we will use the month with minimal maximum irradiance ($Wmax_{min}$), January with following maximum irradiance ($Wmax_{Jan}$), temperature ($T_{Jan}$) and Vapour Pressure Deficit ($VPD_{Jan}$): `r Env[1,]`.

For each voxel the leaf area density $dens$ depends on total leaf area ($LA$) and crown volume ($crowvolume$) and is inititalized to $dens_0 = 0.8$. Then $LAI[h]$ from a $h$ layer of crown is computed by summing each voxel containing leaf from the crown layer. We finally obtain Photosynthetic Photon Flux Density ($PPFD$) from a layer with following formulae:
$$dens_{t-1} = \frac{LA_{t-1}}{crownvolume_{t-1}}$$
$$PPFD[h] = Wmax*e^{-K_{light}*LAI[h]},~~K_{light} = 0.9$$

**Leaf density $dens$ seemed to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 3). Still figure 3 suggested that the issue of low LMA species appeared because $LA$ nerver started to exponentially increase in Symphonia sp 1.**

```{r dens, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
data <- melt(site[c('iter', 'species', 'LA','crownvolume','dens')], id = c('iter', 'species'))
# data <- melt(site[c('iter', 'species', 'ddbh', 'dens', 'yLA', 'mLA', 'oLA', 'LA')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y') ; rm(site, data)
```

Figure 3: Leaf area ($LA$), crown volume ($crownvolume$) and leaf density ($dens$) for a low LMA species (Symphonia sp 1) and a standard LMA species (Dicorynia guianensis).

And if we assume a crown depth of one meter:
$$PPFD[h] = Wmax*e^{-K_{light}*dens_{t-1}*CrownDepth},~~K_{light} = 0.9$$
$$crownvolume = \pi*(CrownRadius*LH)^2*CrownDepth*LV,~~LH=1,~~LV=1$$
$$PPFD[h]_{t} = Wmax*e^{-K_{light}*\frac{LA_{t-1}}{\pi*CrownRadius_{t-1}^2}},~~K_{light} = 0.9, ~~ \pi = 3.14$$

**$PPFD$ seemed to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 4). Still figure 3 suggested that the issue of low LMA species appeared because $CrownRadius$ is growing faster than leaf area ($LA$).**

```{r PPFD, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
site$kPPFD <- site$PPFD/1000
data <- melt(site[c('iter', 'species', 'LA','CR', 'kPPFD')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y') ; rm(data)
```

Figure 4: Leaf area ($LA$), crown radius ($CrownRadius$) and Photosynthetic Photon Flux Density ($PPFD$) for a low LMA species (Symphonia sp 1) and a standard LMA species (Dicorynia guianensis).

So in January and for a crown depth of 1, we get:
$$PPFD_{Jan,t}[h] = `r round(Env[1,1],2)`*e^{-`r round(0.9/3.14,2)`*\frac{LA_{t-1}}{CrownRadius_{t-1}^2}}$$

**PPFD varied relatively few in TROLL simulations (see table 1). And we are interested in the minimal values that will have more impact on low LMA species. So for subsequent numeric applications we will use $PPFD_{min} = 1204$.**

Table 1: Range of Photosynthetic Photon Flux Density ($PPFD$) for both low LMA species (Symphonia sp 1) and standard LMA species (Dicorynia guianensis).

```{r PPFD val}
kable(t(data.frame(unclass(summary(site$PPFD)))), row.names = F)
PPFD <- min(site$PPFD) ; rm(site)
```

## Photosynthesis

Gross carbon assimilation rate $A$ is calculated with the apparent kinetic constant of the Rubisco $Km_T$ inside TROLL. $Km_T$ is itself calculated with temperature $T$, atmospheric CO2 concentration $Cair$, kinetic constant of the Rubisco for carbon $Kc_T$ and kinetic constant of the Rubisco for dioxygen $Ko_T$. Finally, both $Kc_T$ and $Ko_T$ are calculated with temperature $T$ and the ideal gas constant $R$. For more readability factor of the exponential term $vCfactor$ used for $Kc_T$ and $Ko_T$ was written in a separate formula:
$$vCfactor = \frac{T - 25}{298*R*10^-3*(273 + T)}, ~~ R = 8.314$$
$$Kc_{T} = 404*e^{59.36*vCfactor}$$
$$Ko_{T} = 248*e^{-35.94*vCfactor}$$
$$Km_{T} = \frac{Kc_{T}}{Cair}*(1+\frac{210}{Ko_{T}}), ~~ Cair = 360$$
With January values we obtain:
```{r KmT}
denTB <- function(Temp, R = 8.314) 1/(R*(10^-3)*(Temp + 273.15))
vCfactor <- function(Temp, R = 8.314) (Temp - 25)/((298*R*(10^-3)*(273 + Temp)))
KcT <- function(Temp, R = 8.314) 404*exp((59.36*vCfactor(Temp, R)))
KoT <- function(Temp, R = 8.314) 248*exp((-35.94*vCfactor(Temp, R)))
KmT <- function(Temp = Env[1,2], R = 8.314, Cair = 360) (KcT(Temp, R)/Cair)*(1+(210/KoT(Temp, R)))
```
$$Km_{Jan} = `r round(KmT(),2)`$$

In addition gross carbon assimilation rate $A$ is also calculated with the maximum rate of carboxylation $Vcmax$ and the maximal electron transport capacity $Jmax$. $Vcmax$ and $Jmax$ are both calculated with allometry using $LMA$, nitrogen mass $Nmass$ and phosphorous mass $Pmass$:
$$Vcmax = LMA*10^{min(-1.56 + 0.43*log_{10}(10^4*Nmass) + 0.37*log_{10}(\frac{10^4}{LMA})~;~-0.80 + 0.45*log_{10}(10^4*Pmass) + 0.25*log_{10}(\frac{10^4}{LMA}))}$$
$$Jmax = LMA*10^{min(-1.50 + 0.41*log_{10}(10^4*Nmass) + 0.45*log_{10}(\frac{10^4}{LMA})~;~-0.74 + 0.44*log_{10}(10^4*Pmass) + 0.32*log_{10}(\frac{10^4}{LMA}))}$$
We can simplfy in:
$$Vcmax = LMA*10^{min(1.64 + 0.43*log_{10}(Nmass) - 0.37*log_{10}(LMA)~;~2.00 + 0.45*log_{10}(Pmass) - 0.25*log_{10}(LMA))}$$
$$Jmax = LMA*10^{min(1.94 + 0.41*log_{10}(Nmass) - 0.45*log_{10}(LMA)~;~2.30 + 0.44*log_{10}(Pmass) - 0.32*log_{10}(LMA))}$$
**Looking at species functional traits we can see that we will mainly use $Vcmax$ computed with $Nmass$ and $Jmax$ with $Pmass$ (see figure 5).**

```{r Vcmax, fig.height=4}
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA', 'Nmass', 'Pmass')]
Vcmax <- function(sp){
  LMA <- sp[1] ; Nmass <- sp[2] ; Pmass <- sp[3]
  VcmaxN <- LMA*10^(1.64 + 0.43*log10(Nmass) - 0.37*log10(LMA))
  VcmaxP <- LMA*10^(2.00 + 0.45*log10(Pmass) - 0.25*log10(LMA))
  return(c(VcmaxN, VcmaxP))
} 
Jmax <- function(sp){
  LMA <- sp[1] ; Nmass <- sp[2] ; Pmass <- sp[3]
  JmaxN <- LMA*10^(1.94 + 0.41*log10(Nmass) - 0.45*log10(LMA))
  JmaxP <- LMA*10^(2.30 + 0.44*log10(Pmass) - 0.32*log10(LMA))
  return(c(JmaxN, JmaxP))
}
species <- cbind(species, t(apply(species, 1, Vcmax)), t(apply(species, 1, Jmax)))
names(species)[4:7] <- c('VcmaxN', 'VcmaxP', 'JmaxN', 'JmaxP')
data <- melt(species[c('LMA', 'VcmaxN', 'VcmaxP', 'JmaxN', 'JmaxP')], id = 'LMA')
ggplot(data, aes(x = LMA, y = log(value), color = variable)) + geom_point() + geom_line() ; rm(data, species, Vcmax, Jmax)
```

Figure 5: Maximum rate of carboxylation $Vcmax$ and maximal electron transport capacity $Jmax$ computed with nitrogen mass $Nmass$ or phosphorous mass $Pmass$.

We can simplfy in:
$$Vcmax = LMA*10^{1.64 + 0.43*log_{10}(Nmass) - 0.37*log_{10}(LMA)}$$
$$Jmax = LMA*10^{2.30 + 0.44*log_{10}(Pmass) - 0.32*log_{10}(LMA)}$$
**If we use allometries from @wright_worldwide_2004, we can replace $Nmass$ and $Pmass$ by $LMA$ in last $Vcmax$ and $Jmax$ equations:**
$$log_{10}(Nmass*10^4) = 1.4192 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass*10^4) = 0.8298 - 0.9040*log_{10}(LMA)$$
$$log_{10}(Nmass) = -2.5808 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass) = -3.1702 - 0.9040*log_{10}(LMA)$$
$$Vcmax = LMA*10^{0.53 - 1.48*log_{10}(LMA)}$$
$$Jmax = LMA*10^{0.90 - 1.71*log_{10}(LMA)}$$

Finally gross carbon assimilation rate $A$ is limited by either Rubisco activity $A_v$ or RuBP regeneration $A_j$. Both $A_v$ and $A_j$ are calculated with the CO2 partial pressure at carboxylation sites $fci$ and the CO2 compensation point in the absence of dark respiration $\gamma_T$. $fci$ is calculated with Vapour Pressure Deficit $VPD$ and stomatal conductance first parameter $g1$ of @citeMedlyn. Whereas $\gamma_T$ is calculated with temperature $T$, atmospheric CO2 concentration $Cair$, and the ideal gas constant $R$.
$A_v$ is also calculated with the apparent kinetic constant of the Rubisco $Km_T$ and the maximum rate of carboxylation for a given temperature $Vcmax_T$ presented in previous paragraphs. Finally $A_j$ is calculated with the electron transport rate $J$. $J$ is itself calculated with the curvature factor $\theta$, the maximal electron transport capacity for a given temperature $Jmax_T$, the apparent quantum yield $\phi$ and Photosynthetic Photon Flux Density $PPFD$ (through $I$ intermediate formula). Lastly $Vcmax_T$ and $Jmax_T$ are calculated respectivelly with $Vcmax$ and $jmax$ with a factor using temperature $T$ and the ideal gas constant $R$ (through $denTB$ intermediate formula). Those we obtain following formulae:

$$denTB = \frac{1}{R*10^-3*(T + 273.15)}, ~~ R = 8.314 $$
$$Jmax_{T} = Jmax*e^{17.57-43.54*denTB}$$
$$Vcmax_{T} = Vcmax*e^{26.35-65.33*denTB}$$
$$\gamma_{T} = \frac{37}{Cair}*e^{vCfactor*23.4},~~Cair = 360$$
$$fci = \frac{g1}{g1 + \sqrt{VPD}}, ~~ g1 = 3.77$$
$$I = 4 * \phi * PPFD, ~~ \phi = 0.06$$
$$J = \frac{0.5}{\theta} * (I + Jmax_{T} - \sqrt{(Jmax_{T} + I)^2 - 4*\theta*Jmax_{T}*I}), ~~ \theta = 0.7$$
$$A = min(A_v ~;~ A_j)$$
$$A_v = \frac{Vcmax_T*(fci - \gamma_T)}{fci + Km_T})$$
$$A_j = \frac{0.25*J*(fci - \gamma_T)}{fci + 2*\gamma_T}$$

**It appears that for our range of varition of LMA that RuBP regeneration $A_j$ will be always smaller than Rubisco activity $A_v$ (see figure 6). Consequently we get:**
$$A = A_j = \frac{J}{4}*\frac{fci - \gamma_T}{fci + 2*\gamma_T} $$

```{r A, fig.height=4}
# Equations
Vmax <- function(LMA) LMA*10^(0.53 - 1.48 *log10(LMA))
Jmax <- function(LMA) LMA*10^(0.90 - 1.71 *log10(LMA))
JmaxT <- function(LMA, Temp = Env[1,2]) Jmax(LMA)*exp((17.57-43.54*denTB(Temp)))
VcmaxT <- function(LMA, Temp = Env[1,2]) Vmax(LMA)*exp((26.35-65.33*denTB(Temp)))
GammaT <- function(Temp = Env[1,2], Cair = 360) (37/Cair)*exp((vCfactor(Temp)*23.4))
fci <- function(VPD = Env[1,3], g1 = 3.77) g1 / (g1 + sqrt(VPD))
I <- function(PPFD = 1204.47, phi = 0.06) 4 * phi * PPFD
J <- function(LMA, theta = 0.7) 
  (0.5/theta)*(I()+JmaxT(LMA)-sqrt((JmaxT(LMA)+I())^2-4*theta*JmaxT(LMA)*I()))
Av <- function(LMA) 
  (VcmaxT(LMA)*(fci()-GammaT()))/(fci()+KmT())
Aj <- function(LMA) 
  (0.25*J(LMA)*(fci()-GammaT()))/(fci()+2*GammaT())
# Graph
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA')]
species$Av <- sapply(species$LMA, Av)
species$Aj <- sapply(species$LMA, Aj)
data <- melt(species, id = 'LMA')
ggplot(data, aes(x = LMA, y = value, color = variable)) + geom_point() + geom_line() ; rm(species, data)
```

Figure 6: Rubisco activity $A_v$ and RuBP regeneration $A_j$ in function of observed $LMA$ in species dataset.

## Autotrophic respiration

Autotrophic respiration in TROLL simulations is partitioned between stem and roots, and canopy. 

### Stem respiration

Stem respiration $Rstem$ is calculated with sapwood thickness $sapthick$, diameter at breast height $dbh$, tree height $height$, crown depth $CrownDepth$ and temperature $T$:
$$Rstem = 39.6*sapthick*\pi*(dbh-sapthick)*(height-CrownDepth)*378.7*t*e^{\frac{T-25}{10*log(2)}},~~\pi=3.14$$
Sapwood thickness $sapthick$ depend on $dbh$:
$$sapthick=0.04,~~dbh \geq 0.08$$
$$sapthick=\frac{dbh}{2},~~dbh < 0.08$$
Simlarly, tree height $height$ depend on $dbh$ and species functional traits maximal height $hmax$ and species height-diameter allometry parameter $ah$:
$$height = hmax * \frac{dbh}{dbh + ah}$$
And crown depth of the tree $CrownDepth$ depend on $height$:
$$CrownDepth = 0.17 + 0.13*height, \forall height \leq 5.0$$
$$CrownDepth = -0.48+0.26*height, \forall height > 5.0$$
**In our cases of early-dying tree from low $LMA$ species, tree did not reached high $dbh$ (see figure 7). So we can consider $sapthick$ equation with $dbh < 0.08$. Similarly because $height$ is an allometry of $dbh$, in our cases of interest, $height$ did not reached $5.0$ allowing us to consider only first equation of $CrownDepth$.**

```{r sapthick, fig.height=4}
load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Run1.Rdata')
plot(mm@layers$Symphonia_sp.1, what = 'dbh', ggplot2 = T) ; rm(mm)
Rstem1 <- function(Temp = Env[1,2], pi = 3.14)
  39.6*(pi/4)*378.7*exp(((Temp-25)/(10*log(2))))
```

Figure 7: Diameter at breast height ($dbh$) for a low LMA species (Symphonia sp 1).

So we got following formulae:
$$Rstem = 39.6*sapthick*\pi*(dbh-sapthick)*(height-CrownDepth)*378.7*t*e^{\frac{T-25}{10*log(2)}}, ~~ t \in |0,1|,~~\pi=3.14$$
$$sapthick=\frac{dbh}{2}$$
$$height = hmax * \frac{dbh}{dbh + ah}$$
$$CrownDepth = 0.17 + 0.13*height$$
**Resulting in following formula with January values:**
$$Rstem_{Jan} = `r round(Rstem1(),2)`*dbh^2*(-0.17+0.13*hmax*\frac{dbh}{dbh + ah})*t, ~~ t \in |0,1|$$
**Finally we can use mean values of hmax and ah among species (resp. 50.06 and 0.323):**
$$Rstem_{Jan} = `r round(Rstem1(),2)`*dbh^2*(-0.17+6.5078*\frac{dbh}{dbh + 0.323})*t, ~~ t \in |0,1|$$

### Canopy respiration

Canopy respiration is calulated with species dark respiration $Rdark$, temperature of day $T$ or night $T_{night}$, and leaf area $LA$ of different stages (young $y$, mature $m$ and old $o$):
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
Species dark respiration $Rdark$ is computed from functional traits (leaf mass per area $LMA$, nitrogen mass $Nmass$, phosphorous mass $Pmass$, and maximum rate of carboxylation $Vxmax$):
$$Rdark = LMA*(8.5341-130.6*Nmass-567.0*Pmass-0.0137*LMA+11.1*Vcmaxm+187600*Nmass*Pmass)*0.001$$
**If we use allometries from @wright_worldwide_2004, we can replace $Nmass$ and $Pmass$ by $LMA$ in previous equations (simlarly to simplification in photosynthesis chapter):**
$$log_{10}(Nmass) = 5.4192 - 0.5921*log_{10}(LMA)$$
$$log_{10}(Pmass) = 4.8298 - 0.9040*log_{10}(LMA)$$
$$Vcmax_m = 10^{0.53 - 1.48*log_{10}(LMA)}$$
$$Jmax_m = 10^{0.90 - 1.71*log_{10}(LMA)}$$
$$Rdark = f(LMA)$$

**Autotrophic respiration $R$ in simulations seemed to be one of major variable implied in tree early death of low $LMA$ species inside TROLL simulations (see figure 8). Still figure 8 suggested that the issue of low LMA species appeared because respiration in stem ($Rstem$) is reaching respiration in canopy during day ($Rday$).**

```{r R, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
site$kPPFD <- site$PPFD/1000
data <- melt(site[c('iter', 'species', 'Rstem','Rday', 'Rnight')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y')
```

Figure 8: Stem respiration ($Rstem$), canopy respiration during day ($Rday$) and night ($Rnight$) for a low LMA species (Symphonia sp 1) and a standard LMA species (Dicorynia guianensis).

## Net carbon uptake

Net carbon uptake formulae are linking gross carbon assimilation rate $A$ to respiration $R$. Growth primary production $GPP$ is calculated with gross carbon assimilation rate $A$ and leaf area $LA$ of different stages (young $y$, mature $m$ and old $o$). Then, net primary production $NPP$ is calculated by substracting respiration of stem ($Rstem$), canopy during day ($Rday$), and canopy during night $Rnight$ to growth primary production $GPP$:
$$GPP = A * \frac{LA_y + 2*LA_m + LA_o}{2} * 189.3$$
$$NPP = \frac{3}{4}*(GPP - \frac{3}{2}*(Rday+Rnight+Rstem))$$

**Growth and net primary production (resp. $GPP$, $NPP$) are greatly correlated ($r = 0.99$, see figure 9). Variation of respirations are too small compared to $GPP$ variations and can be assumed as constant, except for low LMA species.**

```{r GPP, fig.height=4}
siteS <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Symphonia_sp.1/Symphonia_sp.1_0_site3.txt", header=FALSE)[1:96,]
siteS$species <- 'Symphonia_sp.1'
siteD <- read.delim("~/Documents/ECOFOG/Results/disturbance/monoculture/mature/Run1/Model/Dicorynia_guianensis/Dicorynia_guianensis_0_site3.txt", header=FALSE)[1:96,]
siteD$species <- 'Dicorynia_guianensis'
site <- rbind(siteS, siteD) ; rm(siteS, siteD)
names(site) <- c('iter', 'site', 'sp_lab', 'h', 'dbh', 'ddbh', 'litter', 'age', 'LA', 'yLA', 'mLA', 'oLA', 'CR', 'CD', 'dens', 'PPFD', 'GPP', 'NPP', 'Rstem', 'Rday', 'Rnight', 'site', 'LAI3D1', 'LAI3D2', 'flush', 'VPDmean', 'Tmean', 'PPFDmean', 'crownvolume', 'species')
data <- melt(site[c('iter', 'species', 'GPP', 'NPP', 'Rstem','Rday', 'Rnight')], id = c('iter', 'species'))
ggplot(data, aes(x = iter, y = value, color = variable)) + 
  geom_point() + geom_line() + facet_wrap(~ species, scales = 'free_y')
```

Figure 9: Growth and net primary production (resp. $GPP$, $NPP$), and respiration in stem ($Rstem$), canopy during day ($Rday$), and canopy during night ($Rnight$) for a low LMA species (Symphonia sp 1) and a standard LMA species (Dicorynia guianensis).

## Tree growth

Then net primary production $NPP$ is allocated both two stem and leaves to realize tree growth.

### Stem

First increase of volume $volume$ is calculated with net primary production $NPP$, wood specific gravity of the species $wsg$, and fraction of carbon allocated to wood $fallocwood$. Then increase of volume $volume$ is converted in increase of dbh $ddbh$ with previous diameter at breast height $dbh$, tree height $height$ and species height-diameter allometry parameter $ah$:
$$volume = \frac{2.0*NPP}{wsg} * fallocwood * 10^{-6},~~fallocwood = 0.35$$
$$ddbh = \frac{volume}{0.559*dbh*height\frac{3-dbh}{dbh+ah}}$$
$$dbh_{t+1} = dbh + ddbh$$
**If we use mean values of $wsg$, $hmax$ and $ah$ among species (resp. 0.645, 50.06 and 0.323) and height allometry from dbh, we obtain:**
$$ddbh = 3.878*10^{-8}*\frac{NPP}{\frac{(3-dbh)*dbh^2}{(dbh+0.5)^2}}$$

### Leaves

Growth of leaves is calculated starting with the flush of carbon allocated to leaves $flush$. $flush$ is calculated with net primary production $NPP$, LMA of the species $LMA$, and fraction of carbon allocated to canopy $falloccanopy$. Then new leaves of mature stage $new_m$, old stage $new_o$ and litter $litter$ are calculated from previous leaf area $LA$ of different stages (young $y$, mature $m$ and old $o$) and residency times in different stages (young $t_y$, mature $t_m$ and old $t_o$). Residency times in different stages (young $t_y$, mature $t_m$ and old $t_o$) are all calculated with leaf lifespan of species $leaflifespan$. leaf lifespan itself is calculated with @wright_worldwide_2004 allometry with $LMA$. Once new leaves of each leaf area stages calculated, leaf area $LA$ is updated for each stages:
$$flush = \frac{2.0*NPP*falloccanopy*0.68}{LMA},~~falloccanopy = 0.30$$
$$new_m = \frac{LA_y}{t_y},~~t_y=1$$
$$new_o = \frac{LA_m}{t_m}$$
$$litter= \frac{LA_o}{t_o}$$
$$t_m = \frac{leaflifespan}{3}$$
$$t_o = leaflifespan - t_m - t_y,~~t_y=1$$
$$leaflifespan = 1.5+10^{7.18+3.03*log_{10}(LMA*10^-4)} = f(LMA)$$
$$dLA_y = flush - new_m$$
$$dLA_m = new_m - new_o$$
$$dLA_o = new_o - litter$$
$$dLA = dLA_y + dLA_m + dLA_o$$
$$LA_{t+1} = LA + dLA$$
We can summarize increase in leaf area $dLA$ in:
$$dLA = \frac{0.408*NPP}{LMA} - \frac{3}{2*leaflifespan-3}*LA_o$$

## Resolution

### A null increase of $LA$ ?

**If we place ourselves at equilibrium with $LA_t = LA_e$ and $dLA = 0$, we also have $LA_{y,t} = LA_{y,e}$, $LA_{m,t} = LA_{m,e}$, and $LA_{o,t} = LA_{o,e}$, resulting in:**
$$LA_{y,e} = LA_{y,e} + dLA_{y,e} = LA_{y,e} + flush - new_m = LA_{y,e} + flush - LA_{y,e}$$
$$LA_{y,e} = flush$$
$$LA_{m,e} = LA_{m,e} + dLA_{m,e} = LA_{m,e} + new_m - new_o$$
$$LA_{m,e} = LA_{m,e} + \frac{LA_{y,e}}{t_y} - \frac{LA_{m,e}}{t_m} = LA_{m,e} + \frac{LA_{y,e}}{t_y} - \frac{LA_{m,e}}{t_m}$$
$$LA_{m,e} = \frac{flush*leaflifespan}{3}$$
$$LA_{o,e} = LA_{o,e} + dLA_{o,e} = LA_{o,e} + new_o - litter$$
$$LA_{o,e} = LA_{o,e} + \frac{LA_{m,e}}{t_m} - \frac{LA_{o,e}}{t_o} = \frac{t_o}{t_m} * LA_{m,e}$$
$$LA_{o,e} = \frac{2*leaflifespan-3}{leaflifespan} * \frac{flush*leaflifespan}{3}$$
$$LA_{o,e} = \frac{2*leaflifespan-3}{3} * flush$$
If we reintroduce $GPP$ formula from carbon uptake at equlibirum, we get:
$$GPP_e = A * \frac{LA_{y,e} + 2*LA_{m,e} + LA_{o,e}}{2} * 189.3, ~~if~ t=1$$
$$GPP_e = A * \frac{flush + 2*\frac{flush*leaflifespan}{3} + \frac{2*leaflifespan-3}{3} * flush}{2} * 189.3$$
$$GPP_e = 189.3 * A * flush * \frac{2*leaflifespan}{3}$$
Consequently we can obtain $NPP$ equation at equilibrium:
$$NPP_e = \frac{3}{4}*(GPP_e - \frac{3}{2}*(Rday+Rnight+Rstem)) $$
$$Rstem = \frac{2}{3}*GPP_e - \frac{8}{9}*NPP_e -Rday - Rnight $$
$Rstem$ depend on $dbh$ whereas $GPP$, $Rday$ and $Rnight$ depend on $LMA$ and $NPP$. Consequently we have a maximum value of $dbh$ for which we reach an equilibrium and stop producing leaves depending on species LMA and level of $NPP$. We can calculate it with following equations for left member:
$$flush = 0.408*\frac{NPP}{LMA}$$
$$GPP_e = 189.3 * A * flush * \frac{2*leaflifespan}{3}$$
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
$$Rday = Rdark * e^{(T-25)*0.1*log(3.09-0.0215*(25+T))}*0.40*189.3*flush*\frac{2*leaflifespan}{3}$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*\frac{LA_y + 2*LA_m + LA_o}{2}*189.3$$
$$Rnight = Rdark * e^{(T_{night}-25)*0.1*log(3.09-0.0215*(25+T_{night}))}*189.3*flush*\frac{2*leaflifespan}{3}$$
Consequently we get:
$$Rstem = flush * f(LMA) = NPP * f(LMA)$$
$$Rstem = `r round(Rstem1(),2)`*dbh^2*(-0.17+6.5078*\frac{dbh}{dbh + 0.323})$$

Figure 10 present graphical solutions of previous equations at equilibrium for $dLA=0$. Maximum dbh caluclated from equations after which $LA$ stop to increase will be lower than  species functional trait maximum dbh $dmax$ only for extremly low $NPP$ ($0.1$ and $0.01$). So besides we have an idea of the issue, the moment we studied with those equation did not seem to be the good one. When $dLA=0$, $NPP$ is already low and the issue seems to raise earlier (see figure 9).

```{r graph}
rm(data, site, species)
# Right member of equation
A <- function(LMA) Aj(LMA)
Nmass <- function(LMA) 10^(-2.58-0.59*log10(LMA))
Pmass <- function(LMA) 10^(-3.17-0.90*log10(LMA))
Vcmaxm <- function(LMA) 10^(0.53-1.48*log10(LMA))
Jmaxm <- function(LMA) 10^(0.90-1.71*log10(LMA))
Rdark <- function(LMA) LMA*(8.5341-130.6*Nmass(LMA)-567.0*Pmass(LMA)-0.0137*LMA+11.1*Vcmaxm(LMA)+187600*Nmass(LMA)*Pmass(LMA))*0.001 
LL <- function(LMA, method = 'Reich'){ 
  if(method == 'Wright')
    return(0.5+10^(-2.509+1.71*log10(LMA)))
  if(method == 'Reich')  
    return(1.5+10^(7.18+3.03*log10(LMA*0.0001)))}
GPP <- function(LMA, method = 'Reich') 
  189.3*A(LMA)*2*LL(LMA, method)/3*0.408/LMA
Rmb <- function(Temp) 
  exp(((Temp - 25)*0.1*log(3.09-0.0215*(25+Temp))))
Rday <- function(LMA, Temp = Env[1,2], method = 'Reich')
  Rdark(LMA)*Rmb(Temp)*0.40*189.3*2*LL(LMA, method)/3*0.408/LMA
Rnight <- function(LMA, Temp = Env[1,4], method = 'Reich') 
  Rdark(LMA)*Rmb(Temp)*189.3*2*LL(LMA, method)/3 *0.408/LMA
Rstem_LMA <- function(LMA, method = 'Reich') (2/3)*GPP(LMA, method)-(8/9)-Rday(LMA, method = method)-Rnight(LMA, method = method)
# Left member of equation
Rstem_dbh <- function(dbh)
  Rstem1()*dbh^2*(-0.17+6.5078*(dbh/(dbh + 0.232)))
# Getting dbh
Rstem <- function(dbh, LMA, NPP, method = 'Reich') Rstem_dbh(dbh) - NPP * Rstem_LMA(LMA, method)
get_dbh <- function(LMA, NPP, method = 'Reich'){
  FUN <- function(x) Rstem(x, LMA, NPP, method)
  optimize(FUN, c(0,2))$objective
}
NPP <- c(0.01, 0.1, 10, 100)
method <- c('Reich', 'Wright')
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA', 'dmax')]
species$species <- row.names(species)
speciesR <- cbind(species,
                 sapply(NPP, function(NPP) sapply(species$LMA, function(LMA) get_dbh(LMA, NPP, 'Reich'))))
speciesR$method <- 'Reich'
speciesW <- cbind(species,
                 sapply(NPP, function(NPP) sapply(species$LMA, function(LMA) get_dbh(LMA, NPP, 'Wright'))))
speciesW$method <- 'Wright'
species <- rbind(speciesR, speciesW) ; rm(speciesR, speciesW)
names(species)[-c(1:3,8)] <- paste('NPP',NPP)
data <- melt(species, id = c('species', 'LMA', 'method'))
g <- ggplot(data, aes(x = LMA, y = value, color = variable, shape = method, label = species)) + 
  geom_point() + geom_line() + scale_y_log10() + ylab('Maximum dbh (dLA = 0)') ; g
# ggplotly(g)
```

Figure 10: Graphic resolution of the problem. *Maximum $dbh$ for a given level of net primary production ($NPP$) after which respiration cost is too high and provoke stop in leaf area ($LA$) increase resulting in death of the tree. Leaflifespan is calculated either with Reich or Wright allometry (currently TROLL is running with Reich allometry). Species functional trait maximum dbh is indicated in red. If maximum dbh is lower than dmax, then the individual will die in early stage inside the TROLL simulation.*

**Consequently, the issue of early dying low LMA species seems related to a wrong trade-off between stem increase and leaf area increase, i.e. low LMA species are not growing LA fast enough to compensate stem respiration. Finally equations and figure 10 suggest that LMA has a major role on LA through leaf lifespan allometry. Indeed leaf lifespan is controlling both LA cohorts lifespan and fraction of leaf area in each stages (young, mature and old). We could further investigate this direction.**

### A short leaf lifespan ?

Knowing each residency time ($t_o$, $t_m$, $t_o$) from different stages in leaf area $LA$ we can calculate proportion of $LA$ in each stage through simulations:
$$t_y=1~~,~~t_m = \frac{leaflifespan}{3}~~,~~t_o = leaflifespan - t_m - t_y$$
$$leaflifespan = t_y + t_m + t_o$$
**Consequently for one cohort of leaves, we get $t_{LA}=leaflifespan$, so inside this cohort:**
$$\frac{LA_{y,c}}{LA_c}=\frac{1}{LL}~~,~~\frac{LA_{m,c}}{LA_c}=\frac{1}{3}~~,~~\frac{LA_{o,c}}{LA_c}=\frac{2}{3}-\frac{1}{LL}$$
Considering $leaflifespan = 1.5+10^{7.18+3.03*log_{10}(LMA*10^-4)}$, we can caluclate fraction of each stage inside a cohort depending on LMA.

```{r LL}
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="", row.names = 1)[c('LMA')]
species$LL <- LL(species$LMA)
species$young <- 1 / species$LL
species$mature <- 1/3
species$old <- (2/3) - (1/species$LL)
species$species <- row.names(species)
data <- melt(species, id = c('species', 'LMA', 'LL'))
g1 <- ggplot(data, aes(x = LMA, y = value, shape = variable, color = LL, label = species)) + 
  geom_point() + geom_line() + ylab('Fraction of LA') +  geom_vline(xintercept = 75, color = 'red') +
  scale_color_continuous(name = 'leaf\nlifespan\n(LL in months)')
g2 <- ggplot(data, aes(x = LL, y = value, shape = variable, color = LMA, label = species)) + 
  geom_point() + geom_line() + ylab('Fraction of LA') +  geom_vline(xintercept = 7, color = 'red') +
  xlab('leaf lifespan (LL in months)')
plot_grid(g1, g2, labels = c('A', 'B'), nrow = 2) ; rm(g1, g2, species, data)
```

Figure 11: Fraction of leaf area $LA$ in different stages. *Shape represents the stage (young, old, or mature) and vertical red line the limit between low LMA species with the issue and standard LMA species in both subplot A and B. Color represents the leaf lifespan (resp. LMA) in subplot A (resp. B).*

**Figure 11 suggests that leaf lifespan is reaching unrealistically low values (almost three months). Those unrealistically low leaf lifespan seems to be the origin of the early dying tree issue for low LMA species inside simulations. Besides we still did not figure out the mathematical origin of the issue, we can still search for a better allometry to model leaf lifespan, especially for low LMA species.**

# Leaf lifespan allometry

**Leaflifespan is currently computed from Reich allometry. We suggest to find a better allometry with @wright_worldwide_2004 GLOPNET dataset. And maybe we can change the shape of the response curve to better model leaflifespan of low LMA species.**

```{r LL alo}
rm(list = ls()) ; invisible(gc()) 
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[-which(is.na(LES$log.LL)),]
LES <- LES[-which(is.na(LES$log.LMA)),]
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES$LL <- 10^LES$log.LL
LES$LMA <- 10^LES$log.LMA
data <- LES[c('Dataset', 'Species', 'LL', 'LMA')]
g <- ggplot(data, aes(x = LMA, y = LL, label = Species)) +
  geom_smooth(method = 'lm') +
  geom_point(aes(colour = Dataset)) + 
  scale_x_continuous(trans = 'log10') +
  scale_y_continuous(trans = 'log10') +
  ylab('Leaf Lifespan (LL in months)') +
  xlab('Leaf Mass per Area (LMA in g/m2)') +
  geom_label(color = 'blue', aes(x = 60, y = 50, 
            label = "log10(LL) = 1.367 * log10(LMA) - 1.613\nN = 46, P <0.001, R2 = 0.3595"))
g ; rm(LES)
```

Figure 12: Leaf mass per area (LMA) and leaflifespan (LL). *Leaf mass per area (LMA in $g.m^{-2}$) and leaf lifespan (LL in $months$) are taken in GLOPTNET dataset from @wright_worldwide_2004.*

If we assume that both leaf lifespan (LL) and LMA are following log normal distributions, we can write following model:

$$LL_j \sim \mathcal{logN}(\theta_j,\,\sigma LL)\, , ~~j = 1,...,46$$
$$\theta_j = a + b*LMA_j, ~~j = 1,...,46$$
$$LMA_j \sim \mathcal{logN}(LMAobs_j,\,\sigma LMA)\, , ~~j = 1,...,46$$
$$\sigma LL = \frac{1}{\tau LL}, ~~ \sigma LMA = \frac{1}{\tau LMA}$$
$$\tau LL \sim \mathcal{\Gamma}(0.001,\,0.001)\, ,~~ \tau LMA \sim \mathcal{\Gamma}(0.001,\,0.001)\,$$

# References
