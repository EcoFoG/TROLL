---
title: "A minimum LMA in TROLL ?"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(reshape2)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
library(rstan)
library(bayesplot)
library(rstanarm)
library(readr)
cores <- detectCores()
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```

# Data compilation

We compiled data from both TRY and GLOPNET dataset...

```{r traits}
kable(traits <- data.frame(
  name = c('Thick', 'Tough', 'Nm', 'wsg', 'LMA', 'CN', 'P', 'C'),
  trait = c('Leaf thickness', 'Leaf toughness', 'Leaf nitrogen mass', 'Wood specific gravity', 'Leaf mass per area', 'Leaf carbon per nitrogen', 'Leaf phosphorous', 'Leaf carbon'),
  TRYcode = c(46, NA, 57, 4, 11, 146, 58, 570)))
```

```{r species}
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
LESsp <- unique(droplevels(LES$Species))
TRY <- read_delim("~/Documents/ECOFOG/TROLL/inst/extdata/TryAccSpecies.txt",
                  "\t", escape_double = FALSE, trim_ws = TRUE)
species <- data.frame(
  species = LESsp,
  TRYcode = TRY$AccSpeciesID[match(LESsp, TRY$AccSpeciesName)])
species <- species[-which(is.na(species$TRYcode)),]
```

http://www.try-db.org - Data Portal - Request PI Center.

# Leaf lifespan allometry

## Model

Leaflifespan is currently computed from Reich allometry. We suggest to find a better allometry with @wright_worldwide_2004 GLOPNET dataset. And we may change the shape of the response curve to better fit observed leaf lifespan of low LMA species (figure 1).

```{r LL alo}
rm(list = ls())
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
LES <- LES[-which(is.na(LES$log.LMA)),]
data <- cbind(LES[c('Dataset', 'Species')],
              10^LES[paste0('log.',c('LL', 'LMA', 'Nmass', 'Narea',
                                     'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea'))])
names(data) <- c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'Narea',
              'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea')
data <- droplevels(data[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass')])
g <- ggplot(droplevels(data), aes(x = LMA, y = LL, size = Nmass, color = Dataset, label = Species)) +
  geom_point(alpha = 0.5) + xlab('Leaf mass per area (LMA in g/m2)') +
  ylab('Leaf lifespan (LL in months)') + 
  scale_size_continuous(name = 'Leaf nitrogen content\n(Nmass, in mg/g)')
g ; rm(LES, g)
```

Figure 1: Leaf mass per area (LMA), leaf nitrogen content (Nmass) and leaflifespan (LL). *Leaf mass per area (LMA in $g.m^{-2}$), leaf nitrogen content (Nmass, in $mg.g^-1$) and leaf lifespan (LL in $months$) are taken in GLOPTNET dataset from @wright_worldwide_2004.*

We tested different models and we kept subsequant model with the best tradeoff between log likelihood and number of parameters :
$$ {LL_s}_j \sim \mathcal{logN}(log({\mu_s}_j),\,\sigma)\,$$
$$s=1,...,S_{=4}~, ~~j=1,...,n_s, ~~X^{(1)}=LMA, ~~X^{(2)}=Nmass, ~~i=0,...,I_{=2}$$

$${\mu_s}_j =  {\beta_0}_s*e^{{\beta_1}_s*{X_s}_j^{(1)} - {\beta_2}_s*{X_s}_j^{(2)}}$$
$${\beta_i}_s \sim \mathcal{N}({\beta_i},\,\sigma_i)\,^I$$
$$(\beta_i, \sigma, \sigma_i) \sim \mathcal{\Gamma}(0.001,\,0.001)\,^{2I+1}$$
Leaf lifespan ($LL$) is following a lognormal law with location $log({\mu_s}_j)$ and scale $\sigma$. $s$ represents the dataset used to do the fit between 1 and $S=4$, it encompass environmental and protocol variations. $j$ represents the observation for a given site $s$. Finally $X^{(1)}$ represents the LMA and $X^{(2)}$ the leaf nitrogen content (Nmass). Location ${\mu_s}_j$ is the log of the exponential from the difference between LMA and Nmass with parameters ${\beta_0}_s$, ${\beta_1}_s$, and ${\beta_2}_s$. Each ${\beta_i}_s$ is following a normal law located on $\beta_i$ with scale $\sigma_i$. Finally all $beta_i$, $\sigma$, and $\sigma_i$ are assumed without presemption following gamma laws of parameters $10^-2$, $10^-2$.

```{r data}
rstan_options(auto_write = TRUE)
options(mc.cores = detectCores())
S <- length(levels(droplevels(data$Dataset)))
J <- as.numeric(droplevels(data$Dataset))
N <- length(J)
LMA <- (data$LMA/max(data$LMA))
Nmass <- (data$Nmass/max(data$Nmass))
LL <- data$LL
```

```{stan output.var='m1'}
data {
  int S ;
  int N ;
  int J[N] ;
  real LL[N] ;
  real LMA[N] ;
  real Nmass[N] ;
}
parameters {
  real<lower=0,upper=5> sigma ;
  real<lower=2,upper=20> beta_0 ;
  real<lower=2,upper=20> beta_0s[S] ;
  real<lower=0,upper=50> sigma_0 ;
  real<lower=0> beta_1 ;
  real<lower=0> beta_1s[S] ;
  real<lower=0,upper=50> sigma_1 ;
  real<lower=0> beta_2 ;
  real<lower=0> beta_2s[S] ;
  real<lower=0,upper=50> sigma_2 ;
  real<lower=0,upper=3> beta_3 ;
  real<lower=0,upper=3> beta_3s[S] ;
  real<lower=0,upper=50> sigma_3 ;
  real<lower=0,upper=3> beta_4 ;
  real<lower=0,upper=3> beta_4s[S] ;
  real<lower=0,upper=50> sigma_4 ;
}
model {
   real f[N] ;
   for(n in 1:N){
     f[n] = beta_0s[J[n]] * exp(beta_1s[J[n]]*pow(LMA[n],beta_3s[J[n]]) - beta_2s[J[n]]*pow(Nmass[n],beta_4s[J[n]])) ;
   }
   beta_0s ~ normal(beta_0, sigma_0) ;
   beta_1s ~ normal(beta_1, sigma_1) ;
   beta_2s ~ normal(beta_2, sigma_2) ;
   beta_3s ~ normal(beta_3, sigma_3) ;
   beta_4s ~ normal(beta_4, sigma_4) ;
   LL ~ lognormal(log(f), sigma) ;
}
```

```{r m1, include=FALSE}
m1 <- m1
fit1 <- sampling(m1)
```

## Results

```{r functions}
likeligraph <- function(fit1, ...){
  fits <- list(fit1, ...)
  m <- lapply(fits, function(fit) unlist(lapply(fit@sim$samples, function(x) x$lp__[1000:4000])))
  m <- data.frame(do.call('cbind', m))
  names(m) <- paste0('m', 1:dim(m)[2])
  m <- melt(m)
  return(ggplot(m, aes(x = value, color = variable, fill = variable)) +
           geom_density(alpha = 0.3) + xlab('log likelihood'))
}
fitgraph <- function(fit, pars){
  posterior <- as.matrix(fit)
  plot_title <- ggtitle("Posterior distributions", "with medians and 80% intervals")
  r <- mcmc_areas(posterior,  pars = pars, prob = 0.8) + plot_title
  color_scheme_set("mix-blue-pink")
  c <- mcmc_trace(posterior,  pars = pars, n_warmup = 2000,
                   facet_args = list(nrow = 2, labeller = label_parsed)) +
  facet_text(size = 15)
  return(list(r = r, c = c))
}
```

We obtained convergence for the model with a maximum likekihood of **`r max(as.matrix(fit1)[,'lp__'])`**. Figure 2 shows posterior distributions and their associated markov chains. Figure 3 presents model predictions.

```{r results, fig.height=6}
pars <- c("sigma", "beta_0", "sigma_0", "beta_1", "sigma_1", "beta_2", "sigma_2", 
          "beta_3", "sigma_3", "beta_4", "sigma_4", "lp__")
g1 <- fitgraph(fit1, pars = pars)
g1$r ; g1$c
```

Figure 2: Model posterior distributions and associated markov chains.

```{r surf}
pars <- as.matrix(fit1)[which.max(as.matrix(fit1)[,'lp__']),]
LMA_max <- max(data$LMA)
Nmass_max <- max(data$Nmass)
beta_0 <- pars['beta_0']
beta_1 <- pars['beta_1']
beta_2 <- pars['beta_2']
beta_3 <- pars['beta_3']
beta_4 <- pars['beta_4']
LLpred <- function(LMA, Nmass, LMA_max, Nmass_max, beta_0, beta_1, beta_2, beta_3, beta_4){
  fact <- beta_1*(LMA/LMA_max)^beta_3 - beta_2*(Nmass/Nmass_max)^beta_4
  unname(beta_0*exp(fact))
}
n <- 100
pred <- with(data,
             list(LMA = seq(range(LMA)[1], range(LMA)[2], length.out = n),
                  Nmass = seq(range(Nmass)[1], range(Nmass)[2], length.out = n)))
pred$LL <- sapply(pred$LMA, function(x)
  sapply(pred$Nmass, function(y)
    LLpred(x, y, LMA_max, Nmass_max, beta_0, beta_1, beta_2, beta_3, beta_4)))
p <- plot_ly(x = pred$LMA, y = pred$Nmass, z = pred$LL) %>% add_surface() %>%
  add_trace(x = data$LMA, y = data$Nmass, z = data$LL, mode = "markers", type = "scatter3d",
            marker = list(size = 5, color = "red", symbol = 104)) %>%
  layout(title = 'Model predictions',
         scene = list(xaxis = list(title = 'LMA'),
                      yaxis = list(title = 'Nmass'),
                      zaxis = list(title = 'LL')))
chart_link = plotly_POST(p, filename="LL")
chart_link
```

Figure 3: Model predictions.
$$LL =  `r round(beta_0,3)` e^{`r round(beta_1/(LMA_max^beta_3),3)` *LMA^{`r round(beta_3,3)`} -`r round(beta_2/(Nmass_max^beta_3),3)`*Nmass^{`r round(beta_4,3)`} }$$

# References
