---
title: "Leaf lifespan allometry"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(reshape2)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
library(rstan)
library(bayesplot)
library(rstanarm)
library(readr)
library(dplyr)
library(randomForest)
library(GGally)
cores <- detectCores()
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
    cache = T, cache.lazy = F)
```

# Introduction

TROLL model currently compute leaf lifespan with Reich's allometry [@Reich1991a]. But we have shown that Reich's allometry is underestimating leaf lifespan for low LMA species. Moreover simulations estimated unrealistically low aboveground biomass for low LMA species. We assumed Reich's allometry underestimation of leaf lifespan for low LMA species being the source of unrealistically low aboveground biomass inside TROLL simulations. We decided to find a better allometry with @wright_worldwide_2004 GLOPNET dataset.

```{r LL alo}
rm(list = ls())
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
data <- cbind(LES[c('Dataset', 'Species')],
              10^LES[paste0('log.',c('LL', 'LMA', 'Nmass', 'Narea',
                                     'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea'))])
names(data) <- c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'Narea',
              'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea')
data <- droplevels(data[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass')])
g <- ggplot(droplevels(data), aes(x = LMA, y = LL, size = Nmass, color = Dataset, label = Species)) +
  geom_point(alpha = 0.5) + xlab('Leaf mass per area (LMA in g/m2)') +
  ylab('Leaf lifespan (LL in months)') + 
  scale_size_continuous(name = 'Leaf nitrogen content\n(Nmass, in mg/g)')
g ; rm(LES, g)
```

Figure 1: Leaf mass per area (LMA), leaf nitrogen content (Nmass) and leaflifespan (LL). *Leaf mass per area (LMA in $g.m^{-2}$), leaf nitrogen content (Nmass, in $mg.g^-1$) and leaf lifespan (LL in $months$) are taken in GLOPNET dataset from @wright_worldwide_2004.*

# Model

We tested different models and we kept subsequant model with the best tradeoff between model complexity, convergence, likelihoof, and prediction quality (see [leaf lifespan model](LL2.html) ):
$$ {LL_s}_j \sim \mathcal{logN}(\beta_0*e^{{\beta_1}_s*{LMA_s}_j - {\beta_2}_s*{Nmass_s}_j},\,\sigma)\,$$

$$s=1,...,S_{=4}~, ~~j=1,...,n_s$$
$${\beta_i}_s \sim \mathcal{N}({\beta_i},\,\sigma_i)\,^I, ~~(\beta_i, \sigma, \sigma_i) \sim \mathcal{\Gamma}(0.001,\,0.001)\,^{2I+1}$$

Leaf lifespan ($LL$) is following a lognormal law with location $log({\mu_s}_j)$ and scale $\sigma$. $s$ represents the dataset used to do the fit between 1 and $S=4$, it encompass environmental and protocol variations. $j$ represents the observation for a given site $s$. Finally $X^{(1)}$ represents the LMA and $X^{(2)}$ the leaf nitrogen content (Nmass). Location ${\mu_s}_j$ is the log of the exponential from the difference between LMA and Nmass with parameters ${\beta_0}_s$, ${\beta_1}_s$, and ${\beta_2}_s$. Each ${\beta_i}_s$ is following a normal law located on $\beta_i$ with scale $\sigma_i$. Finally all $beta_i$, $\sigma$, and $\sigma_i$ are assumed without presemption following gamma laws of parameters $10^-2$, $10^-2$.

# TRY improvement

## Data gathering

We gathered data from TRY database to evaluate and improve previous model. We requested functional traits available in Bridge dataset and leaf lifespan for tropical species present in GLOPNET dataset and used in TROLL (see table 1).

Table 1: Functional traits gathered with TRY.

```{r traits}
kable(traits <- data.frame(
  name = c('LL', 'SLA', 'N', 'P', 'wsg'),
  trait = c('Leaf lifespan (longevity)',
            'Leaf area per leaf dry mass (specific leaf area, SLA)',
            'Leaf nitrogen (N) content per leaf dry mass',
            'Leaf phosphorus (P) content per leaf dry mass',
            'Stem dry mass per stem fresh volume (stem specific density)'),
  unit = c('month',' $m^2.kg^{-1}$', '$mg.g^{-1}$', '$mg.g^{-1}$', '$mg.mm^{-3}$'),
  TRYcode = c(12, 11, 15, 14, 4))) ; rm(traits)
```

```{r species}
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
LES <- as.character(unique(droplevels(LES$Species)))
TROLL <- row.names(read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt', header=T, dec=".", sep="", row.names = 1))
TROLL <- gsub('_', ' ', TROLL)
species <- unique(c(LES, TROLL))
TRY <- read_delim("~/Documents/ECOFOG/TROLL/inst/extdata/TryAccSpecies.txt", "\t", escape_double = FALSE, trim_ws = TRUE)
species <- data.frame(
  species = species,
  TRYcode = TRY$AccSpeciesID[match(species, TRY$AccSpeciesName)])
species <- species[-which(is.na(species$TRYcode)),]
rm(species, LES, TROLL, TRY)
```

```{r data}
TRY <- read_delim("~/Documents/ECOFOG/TROLL/inst/extdata/TRY2.txt",
    "\t", escape_double = FALSE, trim_ws = TRUE)
TRY <- dcast(TRY, Dataset + SpeciesName ~ TraitName,
               value.var = 'StdValue', fun.aggregate = mean, na.rm = T)[-11]
names(TRY) <- c('Dataset', 'Species', 'LMA', 'C', 'CN', 'LL', 'Nmass', 'P', 'Thick', 'wsg')
TRY$LMA <- 1/TRY$LMA*1000
TRY <- TRY[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'P', 'wsg')]
GLOPNET <- data
data <- left_join(data, TRY[-1], by = 'Species')
data$LMA <- apply(data[c('LMA.x', 'LMA.y')], 1, mean, na.rm = T)
data$LL <- apply(data[c('LL.x', 'LL.y')], 1, mean, na.rm = T)
data$Nmass <- apply(data[c('Nmass.x', 'Nmass.y')], 1, mean, na.rm = T)
data <- data[-which(names(data) %in% c('LMA.x', 'LMA.y', 'LL.x', 'LL.y', 'Nmass.x', 'Nmass.y'))]
data <- data %>%
  group_by(Dataset, Species) %>%
  summarise_all(mean, na.rm = T)
TRY <- TRY[-which(is.na(TRY$LL)), c('Dataset', 'Species', 'LL', 'LMA', 'Nmass')]
TRY <- TRY[-which(is.na(TRY$LMA)),]
```

```{r functions}
fitgraph <- function(fit){
  pars <- fit@model_pars
  beta <- pars[grep('beta', pars)]
  beta <- beta[-grep('s', beta)]
  sigma <- pars[grep('sigma', pars)]
  posterior <- as.matrix(fit)
  r <- mcmc_areas(posterior,  pars = c(beta, sigma, 'lp__'), prob = 0.8)
  c <- mcmc_trace(posterior,  pars = c(beta, sigma, 'lp__'), n_warmup = 2000,
                   facet_args = list(nrow = 2, labeller = label_parsed))
  p <- ggpairs(data.frame(posterior[,beta]))
  return(list(r = r, c = c, p = p))
}
datasub <- function(data, dataset, wsg = TRUE){
  LMAmax <- max(data$LMA)
  Nmax <- max(data$Nmass)
  if(wsg)
    wsgmax <- max(data$wsg)
  if(dataset != 'full')
    data <- data[-which(data$Dataset %in% dataset),]
  mdata <- list(S = length(levels(droplevels(data$Dataset))), 
              N = length(as.numeric(droplevels(data$Dataset))),
              J = as.numeric(droplevels(data$Dataset)),
              LL = data$LL,
              LMA = (data$LMA/LMAmax),
              Nmass = (data$Nmass/Nmax))
  if(wsg)
    mdata$wsg <- data$wsg/wsgmax
  return(mdata)
}
LLpred <- function(fit, data, wsg = TRUE){
  LMA <- data$LMA
  N <- data$Nmass
  if(wsg)
    wsg <- data$wsg
  LMAmax <- max(data$LMA)
  Nmax <- max(data$Nmass)
  if(wsg)
    wsgmax <- max(data$wsg)
  pars <- as.matrix(fit)[which.max(as.matrix(fit)[,'lp__']),]
  beta <- pars[c('beta_0', 'beta_1', 'beta_2', 'beta_3')]
  beta[is.na(beta)] <- 0
  mu <- beta[1] + beta[2]*(LMA/LMAmax) - beta[3]*(N/Nmax)
  if(wsg)
    mu <- mu + beta[4]*(wsg/wsgmax)
  return(exp(mu))
}
evaluate <- function(fit, data, wsg = TRUE){
  mean(sapply(levels(droplevels(data$Dataset)), function(dataset){
    fit1 <- fit[[dataset]]
    data1 <- data[which(data$Dataset == dataset),]
    fi <- LLpred(fit1, data1, wsg)
    yi <- data1$LL
    ei <- yi - fi
    rmse <- sqrt(mean(ei^2))
  }))
}
```

## Data test

We were able to gather a complete dataset with leaf lifespan, mass per area, and nitrogen content for 17 species related to Leaf Physiology Database with TRY. We decided to first test robustness of model **M1** to those data. In order to assess model prediction quality we randomly affected species to two virtual datasets D1 and D2.

```{r m1}
TRY$Dataset <- as.factor(c('D1', 'D2')[sample(2, 17, replace = T)])
mpath <- "~/Documents/ECOFOG/TROLL/inst/doc/LL_models"
# rstan_options(auto_write = TRUE)
# options(mc.cores = detectCores())
# LMAmax <- max(TRY$LMA) ; Nmax <- max(TRY$Nmass)
# mdata <- sapply(c('full', levels(TRY$Dataset)),
#                 function(x) datasub(TRY, x, wsg = F), simplify = F)
# fit <- lapply(mdata, function(x) stan(file = file.path(mpath, 'M1.stan'), data = x))
# eval <- evaluate(fit, TRY, wsg = F)
# fit <- list(full = fit$full, eval = eval)
# path <- file.path(mpath, 'M1.TRY.Rdata')
# save(fit, file = path)
load(file.path(mpath, 'M1.TRY.Rdata'))
g <- fitgraph(fit$full) ; rm(TRY, mpath)
```

Model **M1** with those data obtained a maximum  likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**.

```{r r1}
g$r
```

Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*

```{r c1}
g$c
```

Parameters markov chains. *Light grey area represents warmup iterations.*

```{r p1}
g$p
```

Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*

## New model

We then compiled both GLOPNET and TRY dataset to gather the biggest dataset. Dataset origin conserved for species was the one of the leaf lifespan observed in GLOPNET. We measured variable importance in functionnal traits to explain leaf lifespan with out-if bag method applied on a random forest (see Table 2). We then sampled both model **M1** and a new model **M10** with new variables highlighted by previous test :

$$ {LL_s}_j \sim \mathcal{logN}(\beta_0*e^{{\beta_1}_s*{LMA_s}_j - {\beta_2}_s*{Nmass_s}_j + {\beta_3}_s*{wsg_s}_j},\,\sigma)\,$$

Table 2: Variable importance calculated with out-of the bag method applied on a random forest. *Leaf mass per area (LMA in $g.m^{-2}$), leaf nitrogen content (Nmass, in $mg.g^-1$) and leaf lifespan (LL in $months$) are taken in GLOPNET dataset from @wright_worldwide_2004. Leaf mass per area in TRY (LMAt in $g.m^{-2}$), leaf carbon content (C, in $mg.g^-1$) and leaf carbon per nitrogen (CN , in $g.g^-1$), leaf thickness (Thick in ) and wood specific gravity (wsg in ) are taken in TRY database (https://www.try-db.org).*

```{r OOB}
kable(randomForest(LL ~ LMA + Nmass + LMA + wsg + P,
                   data = data, na.action = na.omit,
                   ntree = 1000, replace = F , importance = T,
                   do.trace = F, keep.forest = T, keep.inbag = T)$importance)
corrplot::corrplot.mixed(
  cor(data[c('LMA', 'Nmass', 'wsg')],
      use = "pairwise.complete.obs"))
```

Figvure 2: Variable correlations. *Leaf mass per area (LMA in $g.m^{-2}$), leaf nitrogen content (Nmass, in $mg.g^-1$) and leaf lifespan (LL in $months$) are taken in GLOPNET dataset from @wright_worldwide_2004. Leaf mass per area in TRY (LMAt in $g.m^{-2}$), leaf carbon content (C, in $mg.g^-1$) and leaf carbon per nitrogen (CN , in $g.g^-1$), leaf thickness (Thick in ) and wood specific gravity (wsg in ) are taken in TRY database (https://www.try-db.org).*

```{r model}
data <- data[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'wsg')] # Not enough data for P currently
data <- data[-which(is.na(data$wsg)),]
data <- data[-which(is.na(data$LMA)),]
LMAmax <- max(data$LMA) ; Nmax <- max(data$Nmass) ; wsgmax <- max(data$wsg)
mpath <- "~/Documents/ECOFOG/TROLL/inst/doc/LL_models"
# rstan_options(auto_write = TRUE)
# options(mc.cores = detectCores())
# mdata <- sapply(c('full', levels(droplevels(data$Dataset))),
#                 function(x) datasub(data, x), simplify = F)
# fits <- lapply(as.list(paste0('M', c(1,10))), function(model){
#   fit <- lapply(mdata, function(x) stan(file = file.path(mpath, paste0(model, '.stan')), data = x))
#   eval <- evaluate(fit, data)
#   fit <- list(full = fit$full, eval = eval)
#   path <- file.path(mpath, paste0(model, '.LL.Rdata'))
#   save(fit, file = path)
# })
fits <- list()
i <- 1
models <- list.files(path = mpath, pattern = '.LL.Rdata')
for(file in models){
  load(file = file.path(mpath, file))
  fits[[i]] <- fit ; rm(fit) ; i <- i + 1
}
names(fits) <- paste0('fit', c(10,1))
g <- fitgraph(fits$fit10$full) ; rm(file, i, models, mpath)
```

Maximum likekihood of **`r max(as.matrix(fits$fit10$full)[,'lp__'])`** for **M10** against **`r max(as.matrix(fits$fit1$full)[,'lp__'])`** for **M1** and RMSEP of **`r round(fits$fit10$eval,3)`** for **M10** against **`r round(fits$fit1$eval,3)`** for **M1**.

```{r r10}
g$r
```

Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*

```{r c10}
g$c
```

Parameters markov chains. *Light grey area represents warmup iterations.*

```{r p10}
g$p
```

Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*

# References
