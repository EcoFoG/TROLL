---
title: "Design of experiment"
author: "Sylvain Schmitt"
date: '`r Sys.Date()`'
output:
  pdf_document: default
  html_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
# devtools::install_github('sylvainschmitt/RconTroll')
library(TROLL)
library(RconTroll)
library(cowplot)
opts_chunk$set(
  echo = T, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = F, cache.lazy = F, include = T)
```

Built with `RconTroll` package version `r packageVersion('RconTroll')` available at https://gitlab.com/sylvain.schmitt/RconTroll and `TROLL` package version `r packageVersion('TROLL')` available at https://gitlab.com/sylvain.schmitt/TROLL within `r R.Version()$version.string` environment.

# Space of experiments

The space of experiments encompass following axes (with their abbreviations and values) :

- **Disturbance:** $dist \in \left\{ 0, (10), 20,  (30), 40, (50), 60, (70), 80, (90) \right\}$
- **Richness:** $rich \in \left\{ 2, 4, 8, 16, 32, 64, 128, 165 \right\}$
- **Mean Diversity Index (to define):** $divmean \in \left\{ to~define \right\}$
- **Variance Diversity Index (to define):** $divvar \in \left\{ to~define \right\}$
- **Seedrain (to include ?):** $seed \in \left\{ to~define \right\}$

We will reduce it to $n_{exp}$ experiments with Ehanced Stochastic Evolutionary (ESE) algorithms following @Jin2005 with the help of `DiceDesign` R package.

# Computation time

For each experiment we need 3 types of simulations:

- **Pre-disturbance mature forest**
- **Disturbance experiment simulations with species assemblages**
- **Disturbance experiment simulations with corresponding monoculture**

We already know that simulating a 500-years old mature forest from an empty plot with TROLL takes approximatively $t_{mature} = 6~hours~22~minutes$ on tabebuia and a 100-years odl disturbed forest takes $t_{dist} = 1~hour~49~minutes$. We can parrallel processing simulation on $n_{cores}$. Consequently computation time we seek to fix is:
$$ T_{tot} = T_{pre-dist} + T_{dist} + T_{dist-mono} $$

## Pre-disturbance mature forest

For each **Richness** level used in the DOE we can define a respective number of species assemblage replicates $n_{sp}(rich)$. Consequently we get pre-disturbance computation time:
$$ T_{pre-dist} = \frac{\sum _{rich \in DOE}  n_{sp}(rich) * t_{mature}}{n_{cores}}$$

## Disturbance experiments with monoculture

For each experiment and each species ($N = 163$), we need a monoculture simulation for Biodiversity effect partitionning following @Loreau2001. Consequently we get computation time of monoculture disturbance experiment:
$$ T_{dist-monot} = \frac{163 * n_{exp} * t_{dist}}{n_{cores}}$$

## Disturbance experiments with species assemblages

For each **Richness** level used in the DOE we can define a respective number of species assemblage replicates $n_{sp}(rich)$. Consequently we get computation time of disturbance experiments with species assemblages:
$$ T_{dist} = \frac{\sum _{rich \in DOE}  n_{sp}(rich) * t_{dist}}{n_{cores}}$$

## Result

```{r time}
# times
tmature <- 22936.5
tdist <- 5840.58
# DOE space
dist <- 0:3*0.25
rich <- (1:4)^4
# Variables to fix
ncores <- 15
nsp <- rep(10, length(rich)) # 2 4 8 16 32 64 128 163
# Computation time
Tpredist <- sum(nsp*tmature)/ncores
Tdistmono <- 163*length(dist)*tdist/ncores
Tdist <- sum(nsp*length(dist)*tdist)/ncores
Ttot <- Tpredist + Tdistmono + Tdist
Ttot <- lubridate::seconds_to_period(Ttot)
```

If we set $n_{cores}$ to `r ncores`, and $n_{sp}$ to `r paste(nsp)`, we get an overall computation time $T_{tot}$ of **`r Ttot@day`D `r Ttot@hour`H `r Ttot@minute`M `r round(Ttot@.Data)`S**.

# References