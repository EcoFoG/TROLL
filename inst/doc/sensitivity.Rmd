---
title: "Trait sensitivity analysis"
author: "Sylvain Schmitt"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
devtools::install_github('sylvainschmitt/RconTroll')
library(TROLL)
library(RconTroll)
library(corrplot)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```

Built with `RconTroll` package version `r packageVersion('RconTroll')` available at https://gitlab.com/sylvain.schmitt/RconTroll and `TROLL` package version `r packageVersion('TROLL')` available at https://gitlab.com/sylvain.schmitt/TROLL.

# Introduction

To study resistance and resilience of ecosystem face to disturbance, highlighting the role of biodiversity, we decided to use TROLL model simulations [@Chave1999]. In order to have get a finer study of simulations response, we need to assess first sensitivity of the TROLL model to different parameters. More particularly we need to assess the importance of functional traits to further better control functional diversities in simulations. We also need to assess sensitivity of the model to see rain constant because we assume it as being one major factor of tree recruitments after disturbance.

# Material and methods

## Functional traits

TROLL model currently encompass following traits:

```{r traits}
species  <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt', header=TRUE, dec=".", sep="")
spsum <- data.frame(
  row.names = names(species[-1]),
  unit = c('$g.cm^-2$', '$g.g^-1$', '$g.g^-1$', '$g.g^-1$', '$m$', '$m$', '', '$cm^3$', '$?$'),
  mean = apply(species[-1], 2, mean),
  vars = apply(species[-1], 2, var)
)
kable(spsum)
```

Table 1: Functional traits of TROLL model species *Traits with their abbreviation, standard unit, mean and variance.*

To assess the sensitivity of TROLL model to species functionnal traits, we performed a sensitivity analysis by fixing species trait values to their mean. Each trait was tested independently. We reduce to a common mean traits with a correlation $r \geq 0.8$ (see figure 1). 

```{r corr}
corrplot.mixed(cor(species[-1]))
```

Figure 1: Correlation of functional traits within TROLL model species *Traits with their abbreviation, standard unit, mean and variance.*

## Seed rain

To assess the sensitivity of TROLL model to seed rain, we performed a sensitivity analysis by fixing simulations seed rain constant to 1%, 10%, 100% and 1000% from is default value.

```{r parameters}
time <- 100 # years
```

Simulations were conducted on Intel Xeon(R) with 32 CPUs of 2.00GHz and 188.9 GB of memory. We assumed maturity of the forest after 500 years of regeneration [@Li] and computed simulation `r time` years after a disturbance event of 40% intensity. Due to computer limitations we did not run replicate (besides it should be necessary to reduce simulation stochasticity).

# Results

```{r control simulations}
# n <- 100
# options(RconTroll.path = '~/Documents/ECOFOG/Results/control')
# # input creations
# replicates <- 1:n
# init(input = 'control.txt', species = species,
#      nbiter = time*12+1, disturb_iter = 1, disturb_intensity = 0.4)
# invisible(sapply(replicates, function(replicate) 
#   dir.create(file.path(getOption("RconTroll.path"), paste0('control', replicate)))))
# bash creation
# if('control.sh' %in% list.files(getOption("RconTroll.path")))
#    unlink(file.path(getOption("RconTroll.path"), 'control.sh'))
# bash <- file(file.path(getOption("RconTroll.path"), 'control.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "TROLL parrallel modelling in shell"  \n\n', file = bash, append = TRUE)
# for(i in replicates){
#   command <- paste0('./', getOption("RconTroll.app"),
#                     ' -i"control.txt" -f"forest.txt" -o./', 
#                     paste0('control', i),
#                     '/', paste0('control', i), ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% cores == i/cores)
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
```

```{r control opening}
# cl <- makeCluster(getOption("cl.cores", cores))
# path <- getOption("RconTroll.path")
# clusterExport(cl, list("replicates", "path"))
# sim <- parLapply(cl, as.list(replicates), function(i){
#  RconTroll::load(name = paste0('control', i), 
#                  path = file.path(path, paste0('control', i)))
# })
# stopCluster(cl)
# names(sim) <- paste0('control', replicates)
# sim <- stack(sim)
# sim <- aggregate(sim)
# control <- sim
# save(control, file = file.path('~/Documents/ECOFOG/Results/control/', 'control.Rdata'))
# rm(list = ls()) ; invisible(gc())
# load(file.path('~/Documents/ECOFOG/Results/control/', 'control.Rdata'))
```

## Functional traits

```{r traits simulations}
# options(RconTroll.path = '~/Documents/ECOFOG/Results/sensitivity')
# # input creations
# traits <- names(species[-1])
# traits <- traits[-which(traits %in% c('Nmass', 'Pmass', 'ah', 'hmax'))]
# invisible(sapply(traits, function(trait){
#   species_t <- species
#   species_t[,trait] <- mean(species_t[,trait])
#   init(input = paste0(trait, '.txt'), species = species_t,
#        nbiter = time*12+1, disturb_iter = 1, disturb_intensity = 0.4)
# }))
# species_t <- species
# species_t[,'ah'] <- mean(species_t[,'ah'])
# species_t[,'hmax'] <- mean(species_t[,'hmax'])
# init(input = 'ah-hmax.txt', species = species_t,
#      nbiter = time*12+1, disturb_iter = 1, disturb_intensity = 0.4)
# traits <- c(traits, 'ah-hmax')
# invisible(sapply(traits, function(trait) dir.create(file.path(getOption("RconTroll.path"), trait))))
# # bash creation
# if('sensitivity.sh' %in% list.files(getOption("RconTroll.path")))
#    unlink(file.path(getOption("RconTroll.path"), 'sensitivity.sh'))
# bash <- file(file.path(getOption("RconTroll.path"), 'sensitivity.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "TROLL parrallel modelling in shell"  \n\n', file = bash, append = TRUE)
# for(i in 1:length(traits)){
#   command <- paste0('./', getOption("RconTroll.app"),
#                     ' -i"', traits[[i]],
#                     '.txt" -f"forest.txt" -o./',
#                     traits[[i]], '/', traits[[i]], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% cores == i/cores)
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
```

```{r traits opening}
# cl <- makeCluster(getOption("cl.cores", cores))
# path <- getOption("RconTroll.path")
# clusterExport(cl, list("traits", "path"))
# sim <- parLapply(cl, as.list(traits), function(trait){
#  TROLL::load(name = trait, path = file.path(path, trait))
# })
# stopCluster(cl)
# names(sim) <- traits
# sim <- stack(sim)
# traits <- sim
# save(traits, file = file.path('~/Documents/ECOFOG/Results/sensitivity/',
#                               'traits.Rdata'))
# rm(list = ls()) ; invisible(gc())
# load(file.path('~/Documents/ECOFOG/Results/traits/', 'traits.Rdata'))
```

## Seed rain

```{r seedrain simulations}
# options(RconTroll.path = '~/Documents/ECOFOG/Results/seedrain')
# # input creations
# intensities <- c(0.01, 0.1, 10)
# intensities <- intensities*200
# invisible(sapply(intensities, function(i){
#   init(input = paste0(i, '.txt'), seedrain = i, species = species,
#        nbiter = time*12+1, disturb_iter = 1, disturb_intensity = 0.4)
# }))
# invisible(sapply(intensities, function(i) dir.create(file.path(getOption("RconTroll.path"), i))))
# # bash creation
# if('seedrain.sh' %in% list.files(getOption("RconTroll.path")))
#    unlink(file.path(getOption("RconTroll.path"), 'seedrain.sh'))
# bash <- file(file.path(getOption("RconTroll.path"), 'seedrain.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "TROLL parrallel modelling in shell"  \n\n', file = bash, append = TRUE)
# for(i in 1:length(intensities)){
#   command <- paste0('./', getOption("RconTroll.app"),
#                     ' -i"', intensities[[i]],
#                     '.txt" -f"forest.txt" -o./',
#                     intensities[[i]], '/', intensities[[i]], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% cores == i/cores)
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
```

```{r seedrain opening}
# cl <- makeCluster(getOption("cl.cores", cores))
# path <- getOption("RconTroll.path")
# clusterExport(cl, list("traits", "path"))
# sim <- parLapply(cl, as.list(traits), function(trait){
#  RconTroll::load(name = trait, path = file.path(path, trait))
# })
# stopCluster(cl)
# names(sim) <- intensities
# sim <- stack(sim)
# seedrain <- sim
# save(seedrain, file = file.path('~/Documents/ECOFOG/Results/seedrain',
#                                 'seedrain.Rdata'))
# rm(list = ls()) ; invisible(gc())
# load(file.path('~/Documents/ECOFOG/Results/seedrain', 'seedrain.Rdata'))
```

# Discussion

# Supplementray materials

# References
