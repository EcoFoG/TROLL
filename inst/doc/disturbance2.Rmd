---
title: "Tropical forest ecosystem answer to disturbance"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 5
    toc_float: yes
  pdf_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
colorlinks: yes
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(TROLL)
library(RconTroll)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(entropart)
library(plotly)
library(readr)
library(dplyr)
library(reshape2)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 12,
    cache = T, cache.lazy = F)
path <- '~/Documents/ECOFOG/Results/disturbance/disturbance/data'
```

```{r functions}
cbind.all <- function(x, y) {
    x.diff <- setdiff(row.names(x), row.names(y))
    y.diff <- setdiff(row.names(y), row.names(x))
    x[c(as.character(y.diff)),] <- 0
    y[c(as.character(x.diff)),] <- 0
    rownames <- row.names(x)
    x <- x[order(row.names(x)),]
    y <- y[order(row.names(y)),]
    data <- data.frame(cbind(x, y))
    row.names(data) <- rownames
    return(data)
}
```

This document presents the results from the disturbance simulations within TROLL model [@Chave1999]. We realized 240 simulations of 4 levels of disturbance with 60 different species assemblages encompassing varying level of both taxonomic and functional diversity. We adapted @Henry2012 framework to measure resilience of ecosystem outputs agregated in ecosystem functions (forest dynmaic, forest production, and forest diversity). We used the cummulative integral of the distance from the ecosystem to equilibrium over 600 years after the disturbance events as a measure of forest ecosystem resilience efficiency. In addition, we used @Loreau2001 biodiversity partioning to study importance of selection and complementarity effects in forest ecosystem answer to disturbance. We found that increased functional diversity was inmproving ecosystem answer to disturbance with a better resilience. In addition, increased taxonomix diversity was increasing chance to have resilient forest exosystems. Finally, we found that the complementarity effects was responsible for early answer of ecosystem to disturbance whereas the selection effects has a long term importance into ecosytem resilience. **Discussion**.

# Introduction

See [master thesis introduction](https://sylvainschmitt.github.io/master-thesis/introduction.html) (**Warning, work in progress**).

# Material and methods

## Design of experiment

In order to assess the role of biodiversity in ecosystem answer to both disturbance, we needed to create a space of experiments encompassing both variation of disturbance, biodiversity and time. Disturbance was represented by percentage of basal area loss (0%, 25%, 50% and 75%), or as a selective logging simulation. Biodiversity was integrated with two components of its components: taxonomic and functional diversities. We used species richness $SR$ to represents taxonomic diversity (5, 25, and 125 species). Functional diversity can be related to numerous components, and @Borgy2017 argued for 5: richness, divergence, regularity, overlap and mean. Because mature forest were created from a bare soil with TROLL simulations, we could not control a priori divergence, regularity and overlap but only assess theim before diturbance. Consequently, we focused on functional richness with convex hull volume $CHV$ and functional mean with community weighted mean $CWM$. For each level of species richness $SR$, we selected 20 communities with growing convex hull volume $CHV$ but with a community weighted means close to the regional species pool community weighted means. Effectivelly, we did not wanted drastic change in community means that could have more effect than functional richness itself. This design of experiments resulted in 60 communities ($5~SR*20~CHV$) and 240 simulations ($60 ~communities*4~levels~of~disturbance$) over 600 years (maturity being assumed after 500 years of regeneration [@Li]). Figure 1 presents the design of experiment for communities biodiversity after the mature forest were simulated, and thus before disturbance. We obtained a broad range of both functionl dispersion $FDis$ and aboveground biomass $AGB$ for simulated forest ecosystems before disturbance.

```{r DOE, echo=FALSE, fig.cap='Figure 1: Experimental design before disturbance. Communities are implemented along a gradient of species richness (SR) and functional dispersion (FDis) resulting in a broad range of aboveground biomass (AGB). FDis was caluclated based on 4 functional traits (leaf mass per area, wood specific gravity, maximum diameter, and maximum height).', cache=TRUE}
# Data prep
load('~/Documents/ECOFOG/Results/disturbance/maturity/matureData.Rdata')
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)
data$richness <- as.factor(floor(as.numeric(as.character(data$sim))))
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
species <- species[row.names(datal$species),]
fd <- suppressWarnings(FD::dbFD(species, t(datal$species), messages = F))
data <- cbind(data, do.call('cbind',
                            fd[c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ')]))
data <- cbind(data, fd$CWM)
rm(fd, species, datal)

# Graph
g <- ggplot(data, aes(x = FDis, y = richness, 
                      label = sim, color = agb/1000)) + 
  geom_point(size = 3) + 
  geom_text_repel() +
  scale_color_continuous("Aboveground\nBiomass\n(AGB, ton C/ha)") +
  xlab("Functional dispersion (FDis)") +
  ylab("Species richness (SR)")

g ; rm(data, g)
```

```{r DOE data}
rich <- c(5,25,125)
cvh <- 1:20
dist <- c(0,25,50,75)
# doe <- data.frame(
#   sim = c(sapply(c(sapply(rich,
#                            function(x) paste0(x, '.', cvh))),
#                   function(y) paste0(y, '.', dist))))
# doe <- cbind(doe, do.call('rbind', sapply(doe$sim, function(x)
#   strsplit(as.character(x), '.', fixed = T))))
# names(doe)[2:4] <- c('richness', 'cvh', 'disturbance')
# mature <- loadStack('~/Documents/ECOFOG/Results/disturbance/maturity/models/')
# save(mature, file = '~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')
# load('~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')
# species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
#                       header=T, dec=".", sep="",
#                       row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
# abund <- lapply(mature@layers, function(layer) tail(layer@abundances$abund, 1))
# abund <- lapply(abund, function(layer)
#   do.call('rbind', apply(layer, 2, function(x) x/ layer['Total'])))
# abund <- lapply(abund, function(layer) data.frame(t(layer)))
# names <- names(abund)
# abund <- data.frame(plyr::rbind.fill(abund))
# abund <- abund[-which(colnames(abund) == 'Total')]
# row.names(abund) <- names ; rm(names)
# species <- species[colnames(abund),]
# fd <- FD::dbFD(species, abund)
# fd <- cbind(fd$FRic, fd$FEve, fd$FDiv, fd$FDis, fd$RaoQ, fd$CWM)
# names(fd) <- c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ',
#                paste0('CWM.', c('LMA', 'wsg', 'dmax', 'hmax')))
# fd <- fd[apply(doe[c('richness', 'cvh')], 1, function(x) paste0(x[1], '.', x[2])),]
# doe <- cbind(doe, fd) ; rm(fd)
# row.names(doe) <- doe$sim
# save(doe, file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceDOE.Rdata')
load(file.path(path, 'disturbanceDOE.Rdata'))
rm(cbind.all)
```

## Ecosystem answer analysis

### Ecosystem functions

Tropical forest ecosystems provides numerous ecosystem services linked to several ecosystem functions. We decided to describe simiulated tropical forests in three major functions: forest dynamic, forest production, and forest diversity. Forest dynamic was represented by aboveground biomass ($AGB$ in $ton~C.ha^{-1}$), basal area ($BA$ in $m^2.ha^{-1}$), total number of stem ($N$), number of stem above $10~cm$ diameter ($N10$), and number of stem above $30~cm$ diameter ($N30$). Forest production was represented by growth pimary productivity ($GPP$ in $MgC.ha^{-1}$), net pimary productivity ($NPP$ in $MgC.ha^{-1}$), tree autotrophic respiration in day ($Rday$ in $MgC.ha^{-1}$) and tree autotrophic respiration in night ($Rnight$ in $MgC.ha^{-1}$). Finally, forest diversity was represented by **??**.

The resilience of metrics values post disturbance were assessed through @Henry2012 formula:

\begin{equation}
  R\left(t\right)=\frac{Recovery\left(t\right)}{Loss\left(t_d\right)} \approx \frac{X_T(t)}{X_C(t)}
\end{equation}

The resilience of the system $R(t)$ at the time $t$ is described by the ratio of recovery $Recovery(t)$ at time $t$ to loss suffered $Loss(t_d)$ at disturbance time $t_d$. But in our peculiar case of tropical forest ecosystems, the equilibrium used to calculate $Loss(t_d)$ can not be reduced to a specific time if the equilibrium is dynamic. Consequently, to encompass undisturbed ecosystem variations throught time, we simulated an undisturbed control ecosystem $C$. And the resilience of the system $R(t)$ at the time $t$ was defined as the ratio of the ecosystem metric values in the disturbed simulation $X_T(t)$ over the the ecosystem metric values from the control $X_C(t)$ . Thus, the value of resilience $R(t)$ is normalized for all simulations and metrics. $R(t)$  will be equal to $R_{eq} = 1$ when reaching the equilibrium value. Consequently we can calculate an euclidean distance to equilibrium $d_{eq}(t)$ as $d_{eq}(t) = \sqrt{(R_{eq} - R(t))^2}$. Ecosystem euclidean distance to equilibrium was calculated in a multi-dimensional space for all three functions described above: forest dynamic (AGB, BA, N, N10, and N30), forest production (GPP, NPP, Rday, and Rnight) and forest diversity (**?**). We then used cummulative integral over time of eulcidean distance to equilibrium to assess simulations resilience.

### Biodiversity effect

Biodiversity is not only a facet of the experimental design and an ecosystem output through forest diversity, but also interact on ecosystem functioning and consequently on its answer to disturbance. Biodiversity ecosystem functioning relation can be split in complementarity and selection effect with @Loreau2001 partitioning:

\begin{equation}
  \begin{array}{c}
    NE = X_O - X_E = CE + SE \\
    CE = N* \overline{\Delta RX} \overline{M}\\
    SE = N*cov(\Delta RX,M)
  \end{array}
\end{equation}

Biodiversity net effect $NE$ is based on the difference between ecosystem variable $X$ observed value $X_O$ within the community mixture of species and its expected value $X_E$ if species performance were equal to their performance in monocultures. This effect can be partitioned between complementarity effect $CE$, representing niche partitionning, positive interactions, and resource supply, and selectvie effect $SE$ due to dominant species pool driving the ecosystem. Both metrics depend on the variation of relative ecosystem variable $\Delta RX$:

\begin{equation}
  \Delta RX_{sp} = \frac{X_{sp}(mixture)}{X_{sp}(monoculture)} - P_{sp}
\end{equation}

$X_{sp}$ is the ecosystem variable value for one species either in mixture $X_{sp}(mixture)$ or in monoculture $X_{sp}(monoculture)$. $P_{sp}$ is the proportion of the species in the mixture represented by species relative abundance. Consequently, $CE$ averages diversity effects of all species presents in the mixture (both negatives and positives). Whereas $SE$ become positive when dominant species outperform theimselves in mixture than in monoculture, and negative when less dominant species outperform theimselves in mixture than in monoculture [@Tobner2016]. But similarly to resilience measurement, biodiversity net effect $NE$ can be in a dynamic equilibrium and vary over time without disturbance. So in order to correctly assess selection and complementarity effect in answer to disturbance, we normalized it by undisturbed control ecosystem net effect $NE_C$ to measure treatments net effect resilience $R(NE_T)$:

\begin{equation}
  \Delta R(NE_T) = \frac{NE_T}{NE_C} = \frac{SE_T}{NE_C} + \frac{CE_T}{NE_C}
\end{equation}


Resilience trajectories of ecosystem variable after disturbance were partitioned between complementarity effect $CE$ and selection effect $SE$. In order to do that, the design of experiment was repeated for each species indivdually representing 652 simulations of monoculture.

# Results

## Ecosystem functions

```{r ecosystem}
# disturbance <- loadStack('~/Documents/ECOFOG/Results/disturbance/disturbance/models/')
# save(disturbance, 
     # file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbance.Rdata')
# ecosystem <- extractData(disturbance)
# save(ecosystem, file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceData.Rdata')
# data <- ecosystem
load(file.path(path, 'disturbanceData.Rdata'))
```

```{r forest diversity}
# load(file.path(path, 'disturbanceData.Rdata'))
# diversity <- lapply(disturbance@layers, function(layer){
#   cat(layer@name, '\n')
#   apply(layer@abundances$relabund, 1, entropart::Diversity, q = 1)})
# diversity <- do.call('cbind', diversity)
# diversity <- diversity[seq(0,7200,12),]
# diversity <- melt(diversity)
# names(diversity) <- c('time', 'sim', 'div1')
# save(diversity, 
#      file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceDiv.Rdata')
load('~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceDiv.Rdata')
diversity %>% 
  left_join(., doe, by = 'sim') %>%
  ggplot(aes(x = time, y = div1, color = FDiv)) +
  facet_grid(richness ~ disturbance, scale = 'free') +
  geom_point()
```


```{r resilience}
# sim <- c(sapply(rich, function(r) paste0(r, '.', cvh)))
# time <- unique(data$time)
# resilience <- sapply(sim, function(s){
#   data_s <- data[which(data$sim %in% paste0(s, '.', dist)),]
#   data_s <- sapply(time, function(t){
#     data_t <- subset(data_s, time == t)
#     T0 <- which(data_t$sim == paste0(s, '.0'))
#     data_t[-c(1:2)] <- apply(data_t[-c(1:2)], 2, function(x) x/x[T0])
#     return(data_t[-T0,])
#   }, simplify = F)
#   data_s <- do.call('rbind', data_s)
# }, simplify = F) ; rm(sim, time)
# resilience <- do.call('rbind', resilience)
# save(resilience, file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceResilience.Rdata')
load(file.path(path, 'disturbanceResilience.Rdata'))
```

```{r Deq}
deq <- data.frame(
  time = resilience$time,
  sim = resilience$sim,
  structure = apply(resilience[c('agb', 'ba', 'n', 'n10', 'n30')], 1, 
                  function(x) sqrt(sum((rep(1, length(x)) - x)^2))),
  production = apply(resilience[c('gpp', 'npp', 'Rday', 'Rnight')], 1, 
                  function(x) sqrt(sum((rep(1, length(x)) - x)^2)))
)
```

```{r Ieq}
sim <- c(sapply(c(sapply(rich, function(r) paste0(r, '.', cvh))), function(x) paste0(x, '.', dist[-1])))
Ieq <- sapply(sim, function(s){
  data_s <- subset(deq, sim ==s)
  return(cbind(data_s[c(1,2)], cumsum(data_s[-c(1,2)])))
}, simplify = F) ; rm(sim)
Ieq <- data.frame(do.call('rbind', Ieq))
names(Ieq)[3:4] <- paste0('Ieq.', names(Ieq)[3:4])
```

We transformed all ecosystem outputs from the 240 simulations in resilience metrics normalizing the treatment values by their corresponding control (Figure 2.A et 2.B). We then gathered ecosystem outputs by main ecosystem functions (forest dynamic, forest production and forest diversity) to compute ecosystem distance to equilibrium (Figure 2.C). Finally, we integrated distance to equilibrium in a cummulative sum over time (Figure 2.D). 

```{r data process, echo=FALSE, fig.cap='Figure 2: Ecosystem outputs data transformation. Ecosystem outputs (**A**) are normalized by the control value over time to calculate resilience (**B**); resilience of different ecosystem outputs is then used in a multidimensional space to caluclate ecosystem distance to equilibrium (**C**); finally distance ot equilibirum is integrated over time in a cummulative sum (**D**). ', cache=TRUE}
g_agb <- ecosystem %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>% 
  filter(cvh == 1) %>% 
  ggplot(aes(x = time, y = agb/1000, color = disturbance)) +
  geom_point() +
  xlab('Time (years)') +
  ylab('Aboveground biomass (tonC/ha)') +
  scale_color_discrete('Disturbance\nintensity\n(% of BA)')
g_resilience <- resilience %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>% 
  filter(cvh == 1) %>% 
  ggplot(aes(x = time, y = agb, color = disturbance)) +
  geom_hline(yintercept = 1, col = 'red') +
  geom_point() +
  xlab('Time (years)') +
  ylab('Resilience of aboveground biomass') +
  scale_color_discrete('Disturbance\nintensity\n(% of BA)')
g_deq <- deq %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>% 
  filter(cvh == 1) %>% 
  ggplot(aes(x = time, y = structure, color = disturbance)) +
  geom_hline(yintercept = 0, col = 'red') +
  geom_point() +
  xlab('Time (years)') +
  ylab('Distance to forest dynamic equilibrium\n(AGB, BA, N, N10 and N30)') +
  scale_color_discrete('Disturbance\nintensity\n(% of BA)')
g_Ieq <- Ieq %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>% 
  filter(cvh == 1) %>% 
  ggplot(aes(x = time, y = Ieq.structure, color = disturbance)) +
  geom_point() +
  xlab('Time (years)') +
  ylab('Cummulative integral of\ndistance to forest dynamic equilibrium\n(AGB, BA, N, N10 and N30)') +
  scale_color_discrete('Disturbance\nintensity\n(% of BA)')
cowplot::plot_grid(g_agb, g_resilience, g_deq, g_Ieq, labels = LETTERS[1:4])
```

The ranking was stable over time for the 240 simulations. So we used the cummulative integral after 600 years $Ieq_{600}$ as a measurement of ecosystem resilience. We compared cummulative integral after 600 years to communities taxonomic and functional diversity for each leavel of disturbance (see Figure 3). We found that increased functional diversity [FDiv, @villeger_new_2008] was reducing cummulative integral from ecosystem distance to forest dynamic equilibrium after 600 years ($Ieq_{600}$). In addition, functional eveness was complementary reducing $Ieq_{600}$. Finally species richness was not directly link to $Ieq_{600}$. Effectivelly, low species richness could result in variant $Ieq_{600}$, but increased species richness resulted in increased functional diversity and consequently lower $Ieq_{600}$. We found similar results for all disturbance levels and other ecosystem functions (forest production and forest diversity, see Supplementary materials S1).

```{r gIeq, echo=FALSE, fig.cap='Figure 3: Ecosystem resilience after 600 years with taxonomic and functional diversity for different levels of disturbance. Cummulative integral from ecosystem distance to forest dynamic equilibrium after 600 years was represented against functional diversity [FDiv, @villeger_new_2008] for different level of disturbance (25, 50 and 75% of total basal area); dot shapes represents the species richness whereas dot color represents functional eveness [FEve, @villeger_new_2008].', cache=TRUE}
Ieq %>% 
  left_join(., doe, by = 'sim') %>% 
  filter(time == 600) %>% 
  ggplot(aes(x = FDiv, y = Ieq.structure, label = sim)) + 
  geom_smooth(method = 'lm', alpha = 0.3, colour= 'grey') +
  geom_point(aes(shape = richness, color = FEve)) +
  facet_wrap(~disturbance, scales = "free", labeller = 'label_both') + 
  xlab('Functional diversity (FDiv)') +
  ylab('Cummulative integral from ecosystem 
       distance to forest dynamic equilibrium after 600 years') +
  scale_shape_discrete('Species\nrichness\n(SR)') +
  scale_color_continuous('Functional\neveness\n(FEve)')
```

## Biodiversity effect

```{r NE}
## Biodiversity Net Effect ##
# mature <- loadStack('~/Documents/ECOFOG/Results/disturbance/maturity/models/')
# save(mature, file = '~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')
# load(file = '~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')
# disturbance <- loadStack('~/Documents/ECOFOG/Results/disturbance/disturbance/models/')
# save(disturbance, 
# file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbance.Rdata')
# load('~/Documents/ECOFOG/Results/disturbance/disturbance/disturbance.Rdata')
# md <- loadStack('~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/models/')
# save(md, file = '~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/md.Rdata')
# load('~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/md.Rdata')
# BE <- lapply(disturbance@layers, function(layer) 
#   {cat(layer@name, '\n') ; return(getBE(layer, mature, md))})
# BE <- do.call('rbind', BE)
# save(BE,
# file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceBE.Rdata')
load(file.path(path, 'disturbanceBE.Rdata'))
```

```{r BEresilience}
# sim <- c(sapply(rich, function(r) paste0(r, '.', cvh)))
# time <- unique(BE$time)
# be <- c('NE', 'CE', 'SE')
# BEresilience <- sapply(sim, function(s){
#   cat(s, '\n')
#   data_s <- BE[which(BE$sim %in% paste0(s, '.', dist)),]
#   data_s <- sapply(time, function(t){
#     data_t <- subset(data_s, time == t)
#     T0 <- which(data_t$sim == paste0(s, '.0'))
#     T0_NE <- which(data_t[T0,]$BE == "NE")
#     data_t[-c(1:3)] <- apply(data_t[-c(1:3)], 2, function(x) x/x[T0_NE])
#     return(data_t[-T0,])
#   }, simplify = F)
#   data_s <- do.call('rbind', data_s)
# }, simplify = F) ; rm(sim, time, BE)
# BEresilience <- do.call('rbind', BEresilience)
# save(BEresilience,
# file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceBErecovery.Rdata')
load(file.path(path, 'disturbanceBErecovery.Rdata'))
```

We measured all ecosystem outputs biodiversity net effect by comparing theim to their species corresponding monoculture simulations. The net effect was then partition between selection and complementarity effect. We normalized treatments effect by control net effect (see Table 1) to measure their aboveground biomass resilience to disturbance (see Figure 4). We found that complementarity effect was recovering net effect in the first decades untill it disappeared after a century. On the contrary selection effect was reduced or even removed by the disturbance. It increased during the whole simulation and was greater than complementarity effect only after decades. The time lag for which complementarity effect was non null and greater than selection effect was increasing with disturbance intensity. Finally 600 years after the disturbance event biodiversity net effect was still not recovered for a disturbance intensity greater than 25% of basal area. We obtained those results for aboveground biomass. We found similar results but with an amlified signal for basal area ($BA$) and stem abundance ($N$ but with an inverted signal because of the forest self thinning) (see Supplementary materials S2). Finally, forest growth primary productivity ($GPP$) recovered in few years (proportionnaly to disturbance), and its net effect was maintained by complementarity effect (see Supplementary materials S2).

```{r NE table}
BE %>%
  mutate(agb = agb/1000) %>% 
  filter(BE == 'NE') %>%
  melt(id.vars = c('BE', 'time', 'sim')) %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>%
  filter(disturbance == 0) %>%
  group_by(variable) %>% 
  summarise(mean = mean(value, na.rm = T), 
            'standard deviation' = sd(value, na.rm = T)) %>% 
  filter(variable != 'n30') %>% 
  bind_cols(., data.frame(
    name = c('aboveground biomass', 'basal area', 'number of stems', 
             'number of stems above 10cm dbh', 'growth primary production', 
             'net primary production', 'autotrophic respiration during day',
             'autotrophic respiration during night'),
    unit = c('$tonC.ha^{-1}$', '$m^2.ha^{-1}$', '$n.ha^{-1}$', '$n.ha^{-1}$', 
             '$MgC.ha^{-1}$', '$MgC.ha^{-1}$', '$MgC.ha^{-1}$', '$MgC.ha^{-1}$'))) %>% 
  kable(caption = 'Table 1: Biodiversity net effect mean value and standard deviation for different ecosystem variable.', digits = 3)
```

```{r gBE, echo=FALSE, fig.cap='Figure 4: Resilience of complementarity and selection effects. Complementarity effect (CE) and selection effect (SE) where normalized by control net effect (NEc), thus measuring their resilience over time.', cache=TRUE}
BEresilience %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>% 
  filter(BE %in% c('SE', 'CE')) %>% 
  group_by(time, BE, disturbance, richness) %>%
  summarise(qt1 =quantile(agb, probs=0.05),
            qt2 =quantile(agb, probs=0.75),
            mean=mean(agb),
            n=n()) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 1, color = 'red') +
  geom_hline(yintercept = 0, color = 'blue') +
  geom_ribbon(aes(ymin = qt1, ymax = qt2, fill = BE), alpha = 0.3) +
  geom_line(aes(y = mean, color = BE)) +
  facet_grid(richness ~ disturbance, labeller = 'label_both') +
  xlab('Time (years)') +
  ylab('Recovery of aboveground biomass net effect')
```

# Discussion

# Supplementary materials

## S1: Ecosystem functions

Supplementary materials S1 presents ecosystem resilience after 600 years with taxonomic and functional diversity for different levels of disturbance. It encompass all functionnal diversity components [FRIC, FEve, FDiv, and FDis, @villeger_new_2008]. And it presents results for both forest dynamic (Figure S1.1) and forest production (Figure S1.2).

```{r Ieq.structure all var, echo=FALSE, fig.cap='Figure S1.1: Ecosystem resilience after 600 years with taxonomic and functional diversity for different levels of disturbance. Cummulative integral from ecosystem distance to forest dynamic equilibrium after 600 years was represented against functional diversity [FRIC, FEve, FDiv, and FDis, @villeger_new_2008] for different level of disturbance (25, 50 and 75% of total basal area); dot shapes represents the species richness.', cache=TRUE}
Ieq %>% 
  left_join(., doe, by = 'sim') %>% 
  filter(time == 600) %>%
  select(Ieq.structure, disturbance, richness, FRic, FEve, FDiv, FDis) %>% 
  melt(id.vars = c('Ieq.structure', 'disturbance', 'richness')) %>% 
  ggplot(aes(x = Ieq.structure, y = value)) + 
  geom_smooth(method = 'lm', alpha = 0.3, colour= 'grey') +
  geom_point(aes(shape = richness)) +
  facet_grid(variable~disturbance, scales = "free", labeller = 'label_both') + 
  ylab('Functional diversity') +
  xlab('Cummulative integral from ecosystem 
       distance to forest dynamic equilibrium after 600 years') +
  scale_shape_discrete('Species\nrichness\n(SR)')
```

```{r Ieq.production all var, echo=FALSE, fig.cap='Figure S1.2: Ecosystem resilience after 600 years with taxonomic and functional diversity for different levels of disturbance. Cummulative integral from ecosystem distance to forest production equilibrium after 600 years was represented against functional diversity [FRIC, FEve, FDiv, and FDis, @villeger_new_2008] for different level of disturbance (25, 50 and 75% of total basal area); dot shapes represents the species richness.', cache=TRUE}
Ieq %>% 
  left_join(., doe, by = 'sim') %>% 
  filter(time == 600) %>%
  select(Ieq.production, disturbance, richness, FRic, FEve, FDiv, FDis) %>% 
  melt(id.vars = c('Ieq.production', 'disturbance', 'richness')) %>% 
  ggplot(aes(x = Ieq.production, y = value)) + 
  geom_smooth(method = 'lm', alpha = 0.3, colour= 'grey') +
  geom_point(aes(shape = richness)) +
  facet_grid(variable~disturbance, scales = "free", labeller = 'label_both') + 
  ylab('Functional diversity') +
  xlab('Cummulative integral from ecosystem 
       distance to forest production equilibrium after 600 years') +
  scale_shape_discrete('Species\nrichness\n(SR)')
```

## S2: Biodiversity effect

Supplementary materials S2 presents the resilience of complementarity and selection effects for different ecosystem metrics (AGB, BA, N, GPP and NPP, see Figure S2.1)

```{r allBE, echo=FALSE, fig.cap='Figure S2.1: Resilience of complementarity and selection effects. Complementarity effect (CE) and selection effect (SE) where normalized by control net effect (NEc), thus measuring their resilience over time for different ecosystem variables (AGB, BA, N, GPP).', cache=TRUE}
BEresilience %>% 
  select(BE, time, sim, agb, ba, n, gpp) %>% 
  melt(id.vars = c('BE', 'time', 'sim')) %>% 
  left_join(., doe, by = 'sim') %>%
  filter(richness == 125) %>%
  filter(BE %in% c('SE', 'CE')) %>% 
  group_by(time, BE, disturbance, variable) %>%
  summarise(qt1 =quantile(value, probs=0.05, na.rm = T),
            qt2 =quantile(value, probs=0.75, na.rm = T),
            mean=mean(value, na.rm = T)) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 1, color = 'red') +
  geom_hline(yintercept = 0, color = 'blue') +
  geom_ribbon(aes(ymin = qt1, ymax = qt2, fill = BE), alpha = 0.3) +
  geom_line(aes(y = mean, color = BE)) +
  facet_grid(variable ~ disturbance, scales = "free", labeller = 'label_both') +
  xlab('Time (years)') +
  ylab('Recovery of variable net effect') + 
  ylim(-2.5,2.5)
```

# References