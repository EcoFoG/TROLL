---
title: "Disturbance simulations"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document: 
    theme: journal
    toc: yes
    toc_depth: 5
    toc_float: yes
  pdf_document: default
  word_document: default
csl: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/csl/mee.csl
bibliography: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/library.bib
# csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
# bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
library(readr)
cores <- 16
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
path <- '~/Documents/ECOFOG/Results/disturbance/'
```

Built with `RconTroll` package version `r packageVersion('RconTroll')` available at https://gitlab.com/sylvain.schmitt/RconTroll and `TROLL` package version `r packageVersion('TROLL')` available at https://gitlab.com/sylvain.schmitt/TROLL with `r R.Version()$version.string` environment.

# Design of experiment

```{r Sample, include=FALSE}
# Init
set.seed(42)
n <- 20
rep <- 10^3
dist <- 0:3*0.25
rich <- 5^(1:3)
# # Coms
# species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
#                       header=TRUE, dec=".", sep="",
#                       row.names = 1)[c('LMA', 'wsg', 'hmax', 'dmax')]
# species <- species[-which(row.names(species) == "Tachigali_bracteolata"),]
# proba <- ks::kde(scale(species), eval.points = scale(species))$estimate
# proba <- 1/proba
# coms <- lapply(as.list(rich), function(r)
#   replicate(n*rep, species[sample(row.names(species), r, F, proba),],
#             simplify = F))
# names(coms) <- rich ; rm(proba)
# # Dists
# CWM <- lapply(coms, function(x) do.call('rbind',
#                                         lapply(x, function(y) apply(y,2, mean))))
# Centroids <- lapply(CWM, function(x) apply(x, 2, mean))
# Dist <- data.frame(mapply(function(x,y)
#   apply(x, 1, function(z) sqrt(sum((z - y)^2))), x = CWM, y = Centroids))
# names(Dist) <- paste0('dist.', rich) ; rm(CWM, Centroids)
# # Convex hull
# CH <- lapply(coms, function(x)
#   do.call('rbind', lapply(x, function(y)
#     try(geometry::convhulln(y, options = 'FA')$vol))))
# CH$`5` <- as.numeric(CH$`5`)
# CH <- data.frame(do.call('cbind', CH))
# names(CH) <- paste0('CH.', rich)
# # Sample
# Sample <- cbind(Dist, CH)
# Sample <- list(
#   `5` = Sample[c(1,4)],
#   `25` = Sample[c(2,5)],
#   `125` = Sample[c(3,6)]
# )
# Sample <- lapply(Sample, function(x) x[x[,1] < sd(x[,1]),])
# Sample <- lapply(Sample, function(x) {x$num <- row.names(x) ; return(x)})
# Scale <- lapply(Sample, function(x)
#   seq(from = min(x[,2], na.rm = T), max(x[,2], na.rm = T), length.out = n))
# Sample <- mapply(function(x,y) do.call('rbind', sapply(y, function(z)
#   x[which.min(abs(x[,2] - z)) ,], simplify = F)),  x = Sample, y = Scale, SIMPLIFY = F)
# Sel <- lapply(Sample, function(x) x$num)
# Sel <- mapply(function(x,y) x[as.numeric(y)], x = coms, y = Sel, SIMPLIFY = F)
# Sel <- lapply(Sel, function(x) lapply(x, row.names))
# names(Sel) <- rich
sim <- as.vector(sapply(rich, function(r) paste(r, 1:n, sep = '.')))
# Sel <- unlist(Sel, recursive = F)
# names(Sel) <- sim ; rm(Scale, CH, Dist, coms)
# save(Sel, Sample, file = file.path(path, 'SpeciesSel3.Rdata'))
load(file.path(path, 'SpeciesSel3.Rdata'))
```

The space of experiments encompass following axes (with their abbreviations and values) :

- **Disturbance:** $dist \in \left\{ `r paste(dist)` \right\}$
- **Richness:** $rich \in \left\{ `r paste(rich)` \right\}$
- **Community convexhull volume:** $ch$

Community hypervolume will depend on richness (higher richness implying less choices). So we can already measure possible community hypervolumes depending on the level of richness for a given community mean. To do that we sampled $`r n*rep`$ communities for each richness level. Sampling was done by attributing to each species a probability to be pick inverse of its densities in the 4-dimensional functional trait space computed with R package `ks`. Once random communities sampled, we measured each community mean and calculated community euclidean distance to the metacommunity mean. We wanted to control ecosystem functional composition with community mean. In order to do that, we decided to keep only simulated community for which community euclidean distance to metacommunity mean was smaller than the standard deviation of euclidean distances of all simulated communities. Once potential communities designated for each level of richness, we defined for each leavel of richness $`r n`$ equidistant convexhull volumes and we kept the closest community of each hypervolume level.

We obtained the followin designed of experiment (DOE) without disturbance (to replicate for each 4 levels of disturbance):

```{r DOE, fig.height=4}
DOE <- data.frame(
  Sim = sim,
  Richness = rep(rich, each = n),
  Convexhull = unlist(lapply(Sample, function(x) x[,2])),
  Distance = unlist(lapply(Sample, function(x) x[,1])))
rm(Sample, n, rep)
ggplot(DOE, aes(x = Convexhull, y = Distance, label = Sim)) +
  geom_line() + geom_point() + geom_label() +
  facet_wrap(~ Richness, scales = "free") +
  ylab('Euclidean distance to\nmetacommunity centroÃ¯d') ; rm(DOE)
```

# Mature forest

## Monocultures

```{r mm Sim}
# # Init
# seedrain <- 50 # Seedtrain constant to fix
# dir.create(file.path(path, 'monoculture'))
# dir.create(file.path(path, 'monoculture/mature'))
# sim <- sort(unique(unlist(Sel)))
# invisible(sapply(sim, function(s) dir.create(file.path(path, 'monoculture/mature', s))))
# species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt', header=TRUE, dec=".", sep="")
# Sel <- lapply(sim, function(sp){
#   com <- species[which(species$Name == sp),]
#   com$Freg <- 1
#   return(com)
# })
# names(Sel) <- sim
# invisible(sapply(sim, function(s){
#   init(path = file.path(path, 'monoculture/mature'),
#        input = paste0(s, '.txt'),
#        species = Sel[[s]],
#        numesp = 1,
#        nbiter = 12*600,
#        seedrain = seedrain)
# }))
# # Bash
# if('mature.sh' %in% list.files(file.path(path, 'monoculture/mature')))
#    unlink(file.path(path, 'monoculture/mature', 'mature.sh'))
# bash <- file(file.path(path, 'monoculture/mature', 'mature.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "mature monoculture forest parrallel modelling in TROLL" \n\n',
#     file = bash, append = TRUE)
# for(i in seq_len(length(sim))){
#   command <- paste0('./troll',
#                     ' -i"', sim[i], '.txt"',
#                     ' -o./', sim[i], '/', sim[i], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   cat(paste0(' echo "', sim[i], ' Done" \n'), file = bash, append = TRUE)
#   if(i %/% (cores/2) == i/(cores/2))
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
```

```{r mm Results, fig.height=12, fig.width=12}
# Load stack 
# mm <- loadStack('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/models/')
# save(mm, file = '~/Documents/ECOFOG/Results/disturbance/monoculture/mature/mm.Rdata')

# Data prep & check
# datal <- extractData(mm)
# save(datal, file = '~/Documents/ECOFOG/Results/disturbance/monoculture/mature/mmData.Rdata')
load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/mmData.Rdata')
data <- datal$time
data <- data[data$time %in% round(data$time),]
ggplot(data, aes(x = time, y = agb, colour = sim)) +
    geom_point() + guides(colour = F)

# Functional diversity
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
species <- species[row.names(datal$species),]
data$traits <- apply(species, 1, paste, collapse = ' ')
data <- cbind(data, species) # ; rm(species, datal)

# Plotly
g1 <- ggplot(data, aes(x = ba, y = agb, colour = sim, label = traits)) +
  geom_point() + guides(colour = F)
g2 <- ggplot(data, aes(x = n10, y = n30, colour = sim, label = traits)) +
  geom_point() + guides(colour = F)
g1 ; g2

rm(data, g1, g2)
```

## Communities

```{r pd Sim, include=FALSE}
# # Init
# seedrain <- 50
# dir.create(file.path(path, 'maturity'))
# invisible(sapply(sim, function(s) dir.create(file.path(path, 'maturity', s))))
# species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
#                       header=TRUE, dec=".", sep="")
# names(species)[1] <- 'Name'
# Sel <- lapply(Sel, function(com){
#   com <- species[which(species$Name %in% com),]
#   com$Freg <- 1/dim(com)[1]
#   return(com)
# })
# invisible(sapply(sim, function(s){
#   init(path = file.path(path, 'maturity'),
#        input = paste0(s, '.txt'),
#        species = Sel[[s]],
#        numesp = dim(Sel[[s]])[1],
#        nbiter = 12*600,
#        seedrain = seedrain)
# }))
# # Bash
# if('maturity.sh' %in% list.files(file.path(path, 'maturity')))
#    unlink(file.path(path, 'maturity', 'maturity.sh'))
# bash <- file(file.path(path, 'maturity', 'maturity.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "maturity forest parrallel modelling in TROLL" \n\n', file = bash, append = TRUE)
# for(i in seq_len(length(sim))){
#   command <- paste0('./troll',
#                     ' -i"', sim[i], '.txt"',
#                     ' -o./', sim[i], '/', sim[i], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% (cores/2) == i/(cores/2))
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
# rm(bash, seedrain, i, command, species)
rm(Sel)
```

```{r pd Results, fig.height=12, fig.width=12}
# Load stack
# mature <- loadStack('~/Documents/ECOFOG/Results/disturbance/maturity/models/')
# save(mature, file = '~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')

# Data prep & check
# datal <- extractData(mature)
# save(datal, file = '~/Documents/ECOFOG/Results/disturbance/maturity/matureData.Rdata')
load('~/Documents/ECOFOG/Results/disturbance/maturity/matureData.Rdata')
data <- datal$time
data$richness <- as.factor(floor(as.numeric(as.character(data$sim))))
data <- data[data$time %in% round(data$time),]
var <- sapply(c('agb', 'ba', 'n10', 'n30'), function(var)
  ggplot(data, aes_string(x = 'time', y = var,
                          label = 'sim', colour = 'richness')) +
    geom_point(),
  simplify = F)
plot_grid(plotlist = var, labels = c('AGB', 'BA', 'N10', 'N30'))

# Functional diversity
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)
data$richness <- as.factor(floor(as.numeric(as.character(data$sim))))
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
species <- species[row.names(datal$species),]
fd <- FD::dbFD(species, t(datal$species))
data <- cbind(data, do.call('cbind',
                            fd[c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ')]))
data <- cbind(data, fd$CWM)
rm(fd, species, datal)

# Correlations
corrplot::corrplot.mixed(cor(data[-c(1,6)]), order = 'hclust')

# Graphs
sapply(c('FRic', 'FDis'), function(trait){
  var <- sapply(c('agb', 'ba', 'n10', 'n30'), function(var)
  ggplot(data, aes_string(x = trait, y = var, colour = 'richness'))
  + geom_point(),
  simplify = F)
  plot_grid(plotlist = var, labels = c('AGB', 'BA', 'N10', 'N30'))
}, simplify = F)

sapply(c('LMA', 'wsg', 'dmax', 'hmax'), function(trait){
  var <- sapply(c('agb', 'ba', 'n10', 'n30'), function(var)
  ggplot(data, aes_string(x = trait, y = var, colour = 'richness'))
  + geom_point(),
  simplify = F)
  plot_grid(plotlist = var, labels = c('AGB', 'BA', 'N10', 'N30'))
}, simplify = F)

# DOE
g <- ggplot(data, aes(x = FDis, y = richness, 
                      label = sim, color = agb/1000)) + 
  geom_point(size = 3) + 
  geom_text_repel() +
  scale_color_continuous("Aboveground\nBiomass\n(AGB, ton C/ha)") +
  xlab("Functional dispersion (FDis)") +
  ylab("Species richness (SR)")

g ; rm(data, var)
```

# Disturbance

## Monoculture

```{r md Sim, include=FALSE}
# # Simulations
# sim <- list.dirs('~/Documents/ECOFOG/Results/disturbance/monoculture/mature//models/', full.names = F)[-1]
# sim <- c(sapply(dist, function(d) sapply(sim, function(s) paste0(s, '.', d*100))))
# # Outputs
# dir.create(file.path(path, 'monoculture', 'disturbance'))
# invisible(sapply(sim, function(s) dir.create(file.path(path, 'monoculture', 'disturbance', s))))
# # Inits
# invisible(sapply(sim, function(s){
#   doe <- unlist(strsplit(s, '.', fixed = T))
#   init <- paste0(doe[1],'.txt')
#   file.copy(from = file.path(path, 'monoculture', 'mature', 'parameters', init),
#             to  = file.path(path, 'monoculture', 'disturbance', paste0('init_', init)))
#   }))
# # Forests
# load('~/Documents/ECOFOG/Results/disturbance/monoculture/mature/mm.Rdata')
# invisible(lapply(mm@layers, function(l){
#   cat(l@name, '\n')
#   inventoryFromOutput(l, paste0('forest_', l@name, '.txt'), file.path(path, 'monoculture', 'disturbance'))
# }))
# # Bash
# if('disturbance.sh' %in% list.files(file.path(path, 'monoculture', 'disturbance')))
#    unlink(file.path(path, 'monoculture', 'disturbance', 'disturbance.sh'))
# bash <- file(file.path(path, 'monoculture', 'disturbance', 'disturbance.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "disturbance forest parrallel modelling in TROLL" \n\n', file = bash, append = TRUE)
# for(i in seq_len(length(sim))){
#   doe <- unlist(strsplit(sim[i], '.', fixed = T))
#   init <- paste0('init_', doe[1])
#   forest <- paste0('forest_', doe[1])
#   sylviculture <- paste0('sylviculture_', doe[2])
#   command <- paste0('./troll',
#                     ' -i"', init, '.txt"',
#                     ' -f"', forest, '.txt"',
#                     ' -s"', sylviculture, '.txt"',
#                     ' -o./', sim[i], '/', sim[i], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% cores == i/cores)
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
# rm(bash, i, command)
```

```{r md Results, fig.height=12, fig.width=12}
# Load stack
# md <- loadStack('~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/models/')
# save(md, file = '~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/md.Rdata')

# Data prep & check
# datal <- extractData(md)
# save(datal, file = '~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/mdData.Rdata')
load('~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/mdData.Rdata')
data <- datal$time
data <- data[data$time %in% round(data$time),]
data <- data[data$time > 550,]
orig <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
load('~/Documents/ECOFOG/Results/disturbance/monoculture/disturbance/mdData.Rdata')
data <- datal$time
data <- data[data$time %in% round(data$time),]
species <- 'Dicorynia_guianensis'
data <- data[grep(species, data$sim),]
orig <- orig[grep(species, row.names(orig)),]
data[which(names(data)%in%names(orig))] <- sapply(
  names(orig), function(var){
     x <- data[,which(names(data)==var)]/orig[,which(names(orig)==var)]
  })
thresh <- 0.01
data$stability <- as.numeric(unlist(apply(data[c('agb', 'n10')], 1, function(x) x[1] > (1-thresh) & x[2] > (1-thresh))))
data$stability.first <- 0
data[
  sapply(unique(data$sim), function(s) 
  row.names(data[which(data$sim == s & data$stability == 1),])[
    which.min(data[which(data$sim == s & data$stability == 1),'time'])]),
  'stability.first'] <- 1
data$disturbance <- unlist(lapply(sapply(as.character(data$sim), strsplit, split = '.', fixed = T), '[[', 2))
g <- ggplot(data, aes(x = n10, y = agb, group = sim,
                 shape = disturbance, color = time, 
                 label = paste('Resilience of', 
                               disturbance, '% loss\nof BA in', 
                               time, 'years'))) + 
  geom_point() +
  geom_hline(yintercept = 1, col = 'red') +
  geom_vline(xintercept = 1, col = 'red') +
  xlab('Resilience of number of stems above 10 cm dbh') +
  ylab('Resilience of number of aboveground biomass') +
  scale_color_continuous('Time (years)') +
  scale_shape_discrete('Disturbance intensity\n(% of basal area loss)') +
  geom_point(data=data[data$stability.first == 1,],color="red",size=3) +
  geom_label_repel(data=data[data$stability.first == 1,],
                   nudge_x = data$n10)

rm(data, g)
```

## Communities

```{r d Sim, include=FALSE}
# # Simulations
# sim <- list.dirs('~/Documents/ECOFOG/Results/disturbance/maturity/models/', full.names = F)[-1]
# sim <- c(sapply(dist, function(d) sapply(sim, function(s) paste0(s, '.', d*100))))
# # Outputs
# dir.create(file.path(path, 'disturbance'))
# invisible(sapply(sim, function(s) dir.create(file.path(path, 'disturbance', s))))
# # Inits
# invisible(sapply(sim, function(s){
#   doe <- unlist(strsplit(s, '.', fixed = T))
#   init <- paste0(doe[1], '.', doe[2], '.txt')
#   file.copy(from = file.path(path, 'maturity', 'parameters', init),
#             to  = file.path(path, 'disturbance', paste0('init_', init)))}))
# # Forests
# load('~/Documents/ECOFOG/Results/disturbance/maturity/mature.Rdata')
# invisible(lapply(mature@layers, function(l){
#   cat(l@name, '\n')
#   inventoryFromOutput(l, paste0('forest_', l@name, '.txt'), file.path(path, 'disturbance'))
# }))
# # Bash
# if('disturbance.sh' %in% list.files(file.path(path, 'disturbance')))
#    unlink(file.path(path, 'disturbance', 'disturbance.sh'))
# bash <- file(file.path(path, 'disturbance', 'disturbance.sh'), open = 'a')
# cat(' #!/bin/bash  \n\n', file = bash, append = TRUE)
# cat(' echo "disturbance forest parrallel modelling in TROLL" \n\n', file = bash, append = TRUE)
# for(i in seq_len(length(sim))){
#   doe <- unlist(strsplit(sim[i], '.', fixed = T))
#   init <- paste0('init_', doe[1], '.', doe[2])
#   forest <- paste0('forest_', doe[1], '.', doe[2])
#   sylviculture <- paste0('sylviculture_', doe[3])
#   command <- paste0('./troll',
#                     ' -i"', init, '.txt"',
#                     ' -f"', forest, '.txt"',
#                     ' -s"', sylviculture, '.txt"',
#                     ' -o./', sim[i], '/', sim[i], ' &\n')
#   cat(command, file = bash, append = TRUE)
#   if(i %/% cores == i/cores)
#   cat('wait\n', file = bash, append = TRUE)
# }
# cat('wait\n', file = bash, append = TRUE)
# cat(' echo "TROLL all jobs done"  \n\n', file = bash, append = TRUE)
# close(bash)
# rm(bash, i, command)
```

```{r d Results, fig.height=12, fig.width=12}
# Load stack
# disturbance <- loadStack('~/Documents/ECOFOG/Results/disturbance/disturbance/models/')
# save(disturbance, file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbance.Rdata')

# Data prep & check
# datal <- extractData(disturbance)
# save(datal, file = '~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceData.Rdata')
load('~/Documents/ECOFOG/Results/disturbance/disturbance/disturbanceData.Rdata')
data <- datal$time
data <- data[data$time %in% round(data$time),]
data <- data[which(data$sim %in% 
                     paste0('125.5', c('.0', '.25', '.50', '.75'))),]
g0 <- ggplot(data, aes(x = time, y = agb, color = sim)) +
  geom_point() + geom_line()
time <- unique(data$time)
data <- sapply(time, function(t){
  data_t <- subset(data, time == t)
  T0 <- which(data_t$sim == '125.5.0')
  data_t[c('agb', 'ba', 'n10', 'n30')] <- apply(data_t[c('agb', 'ba', 'n10', 'n30')], 2, function(x) x/x[T0])
  return(data_t[-T0,])
}, simplify = F)
data <- do.call('rbind', data)
g1 <- ggplot(data, aes(x = time, y = agb, color = sim)) +
  geom_point() + geom_line()
doe <- strsplit(as.character(data$sim), '.', fixed = T)
data$richness <- as.factor(unlist(lapply(doe, '[[', 1)))
data$disturbance <- as.factor(unlist(lapply(doe, '[[', 3)))
rm(doe)
thresh <- 0.05
data$stability <- as.numeric(unlist(apply(data[c('agb', 'n10')], 1, function(x) x[1] > (1-thresh) & x[2] > (1-thresh))))
data$stability.first <- 0
data[
  sapply(unique(data$sim), function(s) 
  row.names(data[which(data$sim == s & data$stability == 1),])[
    which.min(data[which(data$sim == s & data$stability == 1),'time'])]),
  'stability.first'] <- 1
g2 <- ggplot(data, aes(x = n10, y = agb, group = sim,
                 shape = disturbance, color = time, 
                 label = paste('Resilience of', 
                               disturbance, '% loss\nof BA in', 
                               time, 'years'))) + 
  geom_point() +
  geom_hline(yintercept = 1, col = 'red') +
  geom_vline(xintercept = 1, col = 'red') +
  xlab('Resilience of stems above 10 cm dbh') +
  ylab('Resilience of number of aboveground biomass') +
  scale_color_continuous('Time (years)') +
  scale_shape_discrete('Disturbance intensity\n(% of basal area loss)') +
  geom_point(data=data[data$stability.first == 1,],color="red",size=3) +
  geom_label_repel(data=data[data$stability.first == 1,],
                   nudge_x = data$n10)
cowplot::plot_grid(g0,g1,g2)
rm(data, var)
```

# References