---
title: "Leaf lifespan"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(flexdashboard)
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(reshape2)
library(ggplot2)
library(cowplot)
library(entropart)
library(plotly)
library(rstan)
library(bayesplot)
library(rstanarm)
library(readr)
library(GGally)
cores <- detectCores()
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
    cache = T, cache.lazy = F)
```

Intro
==================

Issue {data-width=200}
-------------------------------------
    
TROLL model currently compute leaf lifespan with Reich's allometry [@Reich1991a]. But we have shown that Reich's allometry is underestimating leaf lifespan for low LMA species. Moreover simulations estimated unrealistically low aboveground biomass for low LMA species. We assumed Reich's allometry underestimation of leaf lifespan for low LMA species being the source of unrealistically low aboveground biomass inside TROLL simulations. We decided to find a better allometry with @wright_worldwide_2004 GLOPNET dataset.

We tested different models starting from complet model **Mcomp** (*with logged mean*):
$$ {LL_s}_j \sim \mathcal{logN}({\beta_0} + {\beta_1}_s*{LMA_s}_j^{{\beta_3}_s} - {\beta_2}_s*{Nmass_s}_j^{{\beta_4}_s},\,\sigma)\,$$

$$s=1,...,S_{=4}~, ~~j=1,...,n_s$$
$${\beta_i}_s \sim \mathcal{N}({\beta_i},\,\sigma_i)\,^I, ~~(\beta_i, \sigma, \sigma_i) \sim \mathcal{\Gamma}(0.001,\,0.001)\,^{2I+1}$$
We tested models M1 to M9 detailed in following tabs to find the better trade-off between:

1. Complexity (and number of parameters)
2. Convergence
3. Likelihood
4. Prediction quality with Root Mean Square Error of Prediction (RMSEP)

RMSEP was computed by fitting a model without a dataset and evaluating it with the same dataset. RMSEP in results are mean RMSEP for each dataset. Results are shown for each models in eahc model tabs and summarized in [Results](#results) tab.

Table 2: Models summary.
```{r mtab}
mtab <- data.frame(M = paste0('M', 1:9),
                  Model = c(
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA - {\\beta_2}_s*N,\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + LMA^{{\\beta_3}_s} - N^{{\\beta_4}_s},\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA^{{\\beta_3}_s} - {\\beta_2}_s*N^{{\\beta_4}_s},\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA - N,\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + LMA^{{\\beta_3}_s} - N^{{\\beta_4}_s},\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA^{{\\beta_3}_s} - N^{{\\beta_4}_s},\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA,\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + LMA^{{\\beta_3}_s},\\sigma)\\,$",
                    "$LL \\sim \\mathcal{logN}(\\beta_0 + {\\beta_1}_s*LMA^{{\\beta_3}_s},\\sigma)\\,$"))
kable(mtab)
```

LL graph {data-width=200}
-------------------------------------

### Figure 1: Leaf mass per area (LMA), leaf nitrogen content (Nmass) and leaflifespan (LL). *Leaf mass per area (LMA in $g.m^{-2}$), leaf nitrogen content (Nmass, in $mg.g^-1$) and leaf lifespan (LL in $months$) are taken in GLOPNET dataset from @wright_worldwide_2004.*

```{r LL alo}
rm(list = ls())
LES <- read.csv("~/Documents/ECOFOG/TROLL/inst/extdata/GLOPNET.csv", skip = 10)
LES <- LES[which(LES$BIOME == 'TROP_RF'),]
LES <- LES[which(LES$GF == 'T'),]
LES <- LES[-which(is.na(LES$log.LL)),]
LES <- LES[-which(is.na(LES$log.LMA)),]
data <- cbind(LES[c('Dataset', 'Species')],
              10^LES[paste0('log.',c('LL', 'LMA', 'Nmass', 'Narea',
                                     'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea'))])
names(data) <- c('Dataset', 'Species', 'LL', 'LMA', 'Nmass', 'Narea',
              'Amass', 'Aarea', 'Gs', 'Rdmass', 'Rdarea')
data <- droplevels(data[c('Dataset', 'Species', 'LL', 'LMA', 'Nmass')])
g <- ggplot(droplevels(data), aes(x = LMA, y = LL, size = Nmass, color = Dataset, label = Species)) +
  geom_point(alpha = 0.5) + xlab('Leaf mass per area (LMA in g/m2)') +
  ylab('Leaf lifespan (LL in months)') + 
  scale_size_continuous(name = 'Leaf nitrogen content\n(Nmass, in mg/g)')
g ; rm(LES, g)
```

```{r functions}
fitgraph <- function(fit){
  pars <- fit@model_pars
  beta <- pars[grep('beta', pars)]
  beta <- beta[-grep('s', beta)]
  sigma <- pars[grep('sigma', pars)]
  posterior <- as.matrix(fit)
  r <- mcmc_areas(posterior,  pars = c(beta, sigma, 'lp__'), prob = 0.8)
  c <- mcmc_trace(posterior,  pars = c(beta, sigma), n_warmup = 2000,
                   facet_args = list(nrow = 2, labeller = label_parsed))
  p <- ggpairs(data.frame(posterior[,beta]))
  return(list(r = r, c = c, p = p))
}
datasub <- function(data, dataset){
  LMAmax <- max(data$LMA)
  Nmax <- max(data$Nmass)
  if(dataset != 'full')
    data <- data[-which(data$Dataset %in% dataset),]
  return(list(S = length(levels(droplevels(data$Dataset))), 
                          N = length(as.numeric(droplevels(data$Dataset))),
                          J = as.numeric(droplevels(data$Dataset)),
                          LL = data$LL,
                          LMA = (data$LMA/LMAmax),
                          Nmass = (data$Nmass/Nmax)))
}
LLpred <- function(fit, data){
  LMA <- data$LMA
  N <- data$Nmass
  LMAmax <- max(data$LMA)
  Nmax <- max(data$Nmass)
  pars <- as.matrix(fit)[which.max(as.matrix(fit)[,'lp__']),]
  beta <- pars[c('beta_0', 'beta_1', 'beta_2', 'beta_3', 'beta_4')]
  one <- (length(grep('Nmass', fit@stanmodel@model_code)) > 0)
  if(one)
    beta[is.na(beta)] <- 1
  if(!one)
    beta[is.na(beta)] <- 0
  mu <- beta[1] + beta[2]*(LMA/LMAmax)^beta[4] - beta[3]*(N/Nmax)^beta[5]
  return(exp(mu))
}
evaluate <- function(fit, data){
  mean(sapply(levels(droplevels(data$Dataset)), function(dataset){
    fit1 <- fit[[dataset]]
    data1 <- data[which(data$Dataset == dataset),]
    fi <- LLpred(fit1, data1)
    yi <- data1$LL
    ei <- yi - fi
    rmse <- sqrt(mean(ei^2))
  }))
}
```

```{r models, include=FALSE}
mpath <- "~/Documents/ECOFOG/TROLL/inst/doc/LL_models"
# rstan_options(auto_write = TRUE)
# options(mc.cores = detectCores())
# mdata <- sapply(c('full', levels(droplevels(data$Dataset))),
# function(x) datasub(data, x), simplify = F)
# fits <- lapply(as.list(paste0('M', 1:9)), function(model){
#   fit <- lapply(mdata, function(x) stan(file = file.path(mpath, paste0(model, '.stan')), data = x))
#   eval <- evaluate(fit, data)
#   fit <- list(full = fit$full, eval = eval)
#   path <- file.path(mpath, paste0(model, '.LL2.Rdata'))
#   save(fit, file = path)
# })
fits <- list()
i <- 1
models <- list.files(path = mpath, pattern = '.LL2.Rdata')
for(file in models){
  load(file = file.path(mpath, file))
  fits[[i]] <- fit ; rm(fit) ; i <- i + 1
} 
names(fits) <- paste0('fit', 1:9)
```

M1
==================

```{r m1}
fit <- fits$fit1
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA - {\beta_2}_s*N,\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r r1}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c1}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p1}
g$p
```

M2
==================

```{r m2}
fit <- fits$fit2
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + LMA^{{\beta_3}_s} - N^{{\beta_4}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res2}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c2}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p2}
g$p
```

M3
==================

```{r m3}
fit <- fits$fit3
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA^{{\beta_3}_s} - {\beta_2}_s*N^{{\beta_4}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res3}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c3}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p3}
g$p
```


M4
==================

```{r m4}
fit <- fits$fit4
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA - N,\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res4}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c4}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p4}
g$p
```


M5
==================

```{r m5}
fit <- fits$fit5
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + LMA^{{\beta_3}_s} - N^{{\beta_4}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res5}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c5}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p5}
g$p
```

M6
==================

```{r m6}
fit <- fits$fit6
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA^{{\beta_3}_s} - N^{{\beta_4}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res6}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c6}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p6}
g$p
```


M7
==================

```{r m7}
fit <- fits$fit7
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA,\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res7}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c7}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p7}
g$p
```

M8
==================

```{r m8}
fit <- fits$fit8
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + LMA^{{\beta_3}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res8}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c8}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p8}
g$p
```

M9
==================

```{r m9}
fit <- fits$fit9
g <- fitgraph(fit$full)
```

Model {data-width=300}
-------------------------------------

$$ LL \sim \mathcal{logN}(\beta_0 + {\beta_1}_s*LMA^{{\beta_3}_s},\sigma)\,$$
Maximum likekihood of **`r max(as.matrix(fit$full)[,'lp__'])`** and RMSEP of **`r round(fit$eval,3)`**

### Parameters posterior ditribution. *Light blue area represents 80% confidence interval, and vertical blue line the mean.*
```{r res9}
g$r
```

Convergence {data-width=300} 
-------------------------------------

### Parameters markov chains. *Light grey area represents warmup iterations.*
```{r c9}
g$c
```

### Parameters pairs plot. *Parameters density distribution, pairs plot and Pearson's coefficient of correlation.*
```{r p9}
g$p
```

Results
==================

Column {data-width=200}
-------------------------------------

Model **M1** seemed to have shown the best trade-off between complexity ($K=6$ parameters), convergence (see tab [M1](#m1) ), likelihood, and prediction quality (see table 2). Figure 2 presents model prediction confidence interval and figure 3 compare Reich's allometry and model M1 predictions with species functional traits used in TROLL. **Nevertheless we will test other predictors gathered from TRY database following a model with the same response curve (see [leaf lifespan](LL.html) ).**

Table 2: Models likelihood and prediction quality.*Root mean square errof of prediction (RMSEP) was computed by fitting a model without a dataset and evaluating it with the same dataset. RMSEP in results are mean RMSEP for each dataset.*

```{r table}
res <- data.frame(row.names = paste0('M', 1:9),
                  ML = unlist(lapply(fits, function(fit) round(max(as.matrix(fit$full)[,'lp__']),3))),
                  RMSEP = unlist(lapply(fits, function(x) x$eval)))
kable(res)
fit <- fits$fit1$full ; rm(fits)
LMAmax <- max(data$LMA) ; Nmax <- max(data$Nmass)
beta <- as.matrix(fit)[which.max(as.matrix(fit)[,'lp__']),c('beta_0', 'beta_1', 'beta_2')]
```

$$LL = `r round(exp(beta[1]),3)`*e^{`r round(beta[2]/LMAmax,3)` *LMA -`r round(beta[3]/Nmax,3)`*Nmass }$$

Column {data-width=600}
-------------------------------------

### Figure 2: Leaflifespan predictions for model **M1** with leaf mass per area (LMA), and leaf nitrogen content (Nmass). *Leaf lifespan (LL in $months$) is predicted with model M1 fit. Leaf mass per area (LMA in $g.m^{-2}$) and leaf nitrogen content (Nmass, in %) are taken in GLOPNET dataset from @wright_worldwide_2004.* **Warning** *Nmass (resp. LMA) is not constant and depend on the closest point value for left (resp. right) graph.*

```{r graph, fig.width=20}
LLpred <- function(LMA, Nmass, LMAmax, Nmax, beta0, beta1, beta2, sigma){
  mu <- beta0 + beta1*(LMA/LMAmax) - beta2*(Nmass/Nmax)
  rlnorm(1, mu, sigma)
}
pred <- apply(as.matrix(fit), 1, function(x)
  sapply(seq_len(dim(data)[1]), function(i)
      LLpred(data$LMA[i], data$Nmass[i], LMAmax, Nmax, x['beta_0'], x['beta_1'], x['beta_2'], x['sigma'])
    ))
pred <- data.frame(t(apply(pred, 1, function(x) quantile(x, probs = c(0.05, 0.95)))))
names(pred) <- c('5%', '95%')
pred$mean <- exp((beta[1] + beta[2]*(data$LMA/LMAmax) - beta[3]*(data$Nmass/Nmax)))
pred$LMA <- data$LMA
pred$Nmass <- data$Nmass
g <- ggplot(data, aes(x = LMA, y = LL)) +
  geom_ribbon(aes(x = pred$LMA, ymin = pred$`5%`, ymax = pred$`95%`), color = 'grey', alpha = 0.2) +
  geom_line(aes(x = pred$LMA, y = pred$`5%`, color = '5%'), linetype = 2) +
  geom_line(aes(x = pred$LMA, y = pred$`95%`, color = '95%'), linetype = 2) +
  geom_line(aes(x = pred$LMA, y = pred$mean, color = 'mean'), linetype = 2) +
  geom_point() +
  theme_bw() +
  xlab('Leaf mass per area (LMA in g/m2)') +
  ylab('Leaf lifespan (LL in months)') +
  scale_color_manual(name = 'Model',
                     values = c('5%' = 'black',
                                '95%' = 'black',
                                'mean' = 'red'))
h <- ggplot(data, aes(x = Nmass, y = LL)) +
  geom_ribbon(aes(x = pred$Nmass, ymin = pred$`5%`, ymax = pred$`95%`), color = 'grey', alpha = 0.2) +
  geom_line(aes(x = pred$Nmass, y = pred$`5%`, color = '5%'), linetype = 2) +
  geom_line(aes(x = pred$Nmass, y = pred$`95%`, color = '95%'), linetype = 2) +
  geom_line(aes(x = pred$Nmass, y = pred$mean, color = 'mean'), linetype = 2) +
  geom_point() +
  theme_bw() +
  xlab('Leaf nitrogen content (Nmass in %)') +
  ylab('Leaf lifespan (LL in months)') +
  scale_color_manual(name = 'Model',
                     values = c('5%' = 'black',
                                '95%' = 'black',
                                'mean' = 'red'))
# plot_grid(g, h, labels = c('LMA', 'Nmass'))
# p <- subplot(ggplotly(g, width = 800, height = 400), ggplotly(h, width = 800, height = 400), shareY = T, shareX = F, titleX = T)
# chart_link <- plotly_POST(p, filename = "LL1")
# save(chart_link,
     # file = '~/Documents/ECOFOG/TROLL/inst/doc/LL_models/LL1.Rdata')
load('~/Documents/ECOFOG/TROLL/inst/doc/LL_models/LL1.Rdata')
chart_link
```

### Figure 3: Leaflifespan predictions for model **M1** and Reich's allometry with leaf mass per area (LMA), and leaf nitrogen content (Nmass). *Leaf lifespan (LL in $months$) is predicted with model M1 fit or Reich's allometry [@Reich1991a]. Leaf mass per area (LMA in $g.m^{-2}$) and leaf nitrogen content (Nmass, in %) are taken in BRIDGE dataset used by TROLL [@Li].*

```{r TROLL, fig.width=20}
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt', header=T, dec=".", sep="", row.names = 1)[c('LMA', 'Nmass')]
species$`Reich 91` <- 1.5 + 10^(7.18+3.03*log10(species$LMA*0.0001))
species$`Reich 97` <- 10^(2.040816*(2.579713-log10(10000.0/species$LMA)))
species$`Wright 04` <- 0.5+10^(-2.509+1.71*log10(species$LMA))
species$Model <- with(species, exp((beta[1] + beta[2]*(LMA/LMAmax) - beta[3]*(Nmass*100/Nmax))))
g <- ggplot(melt(species, id = c('LMA', 'Nmass')), aes(x = LMA, y = value, color = variable)) +
  geom_point() + theme_bw() +   xlab('Leaf mass per area (LMA in g/m2)') +
  ylab('Leaf lifespan (LL in months)')
h <- ggplot(melt(species, id = c('LMA', 'Nmass')), aes(x = Nmass, y = value, color = variable)) +
  geom_point() + theme_bw() +   xlab('Leaf nitrogen content (Nmass in %)') +
  ylab('Leaf lifespan (LL in months)')
# plot_grid(g, h, labels = c('LMA', 'Nmass'))
# p <- subplot(ggplotly(g, width = 800, height = 400), ggplotly(h, width = 800, height = 400), shareY = T, shareX = F, titleX = T) 
# chart_link <- plotly_POST(p, filename = "LL2")
# save(chart_link,
#      file = '~/Documents/ECOFOG/TROLL/inst/doc/LL_models/LL2.Rdata')
load('~/Documents/ECOFOG/TROLL/inst/doc/LL_models/LL2.Rdata')
chart_link
```

References
==================

