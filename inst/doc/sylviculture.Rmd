---
title: "Sylviculture modelling"
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output:
  html_document:
    theme: journal
    toc: yes
    toc_depth: 5
    toc_float: yes
  pdf_document: default
  word_document: default
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(ggplot2)
library(cowplot)
library(plotly)
cores <- 15
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```

# Introduction

In order to simulate sylviculture with TROLL we need to implement a new sylviculture module inside TROLL model code. A first litterature review was completed by an interview with Laurent Descroix of the Office Nationale des Forêts. This document presents results of both the review and the interview.

This document focuses explicitly on sylviculture as it is realized in french guiana. In this context sylviculture can be narrow to selective logging (besides we will address other questions). Selective logging can be splitted in two parts: **designation** and **harvesting**. Both **designation** and **harvesting** encompass different sylviculture process and effects :

- Trees choice
    - *Harvestable areas*
    - Designation
    - Selection
    - Rotten
- Harvesting
    - Felling
    - Main track
    - Secondary track (cloisonnement)
    - Skidding
    - Other damages

We can model all this process and effects in two ways:

- **Explicitly** by modelling the process *(for well known process or deterministic events)*
- **Implicitly** by taking only into account the result of the processes *(e.g. a local increased mortality)*

All processes detailed after are splitted in two parts: 

- **Reality** explaining what is currently done in french Guiana 
- **Model** explaining how it is model model in TROLL code (giving the algorithm) and suggesting modifications

New code for this module is available [online](https://github.com/sylvainschmitt/TROLL/blob/master/inst/tools/main_2.3.1.cpp) (take care it is a work in progress).

# Trees choice

Before logging we first need to designate and select trees which will be harvested inside simulations.

## *Harvestable areas*

### Reality

First, havrestable areas are defined out of lowland areas and in the remainder by keeping all areas with a slope lower than 22 percent. A buffer of 30 meters is added to all harvestable areas representing engine capacity to extract wood with cables. Note that hazards like climate (dry or drought) can reduce or increase capacity of engine to explore a given area. In case of need bulldozer can be used to go in steeper slopes and grading can be realized to join harvestable areas.

### Model

One major limit of current implementation of TROLL model is that it assumes a flat environment. Consequently the whole simulated area inside TROLL can be considered has an harvestable zone. It conequently simplifies this first part but we need to keep in mind this major assumption in subsequent analysis.

## Designation

### Reality

Trees are then designated directly in the field in three categories: reserve trees for individuals with an ecological interest, future trees for individuals which can be harvested in the next cycles, and harvestable trees which will be sold for harvesting in current cycle. Harvestable trees are designated according to their species and maximum and minimum harvestable diameter associated to the species (detailed available in sylviculture guide). Total basal area of designated trees is then computed and aims 25 $m^3.ha^{-1}$ to be harvested. But because 20-30 percent of designated trees are considered as rotten once probed by the lumberman, total harvestable volume aims 30 $m^3.ha^{-1}$. Finally it happens that there is more or less than 30 $m^3.ha^{-1}$ of designated trees. If there is fewer it will be sold in this state, if there is more the minimum harvestable diameter is increased. The global idea is to gain maximum profit without exceding 25% of aboveground biomass (AGB) disturbance. Last but not least, this direct designation on the field before harvesting does not seems to result in aggregated extraction.

### Model

The harvestable area is the whole simulated forest. We needed to integrate an external file with all harvestable species precising their minimum and maximum harvestable diameter (following the sylviculture guide). We added to this sylviculture parameter file all parameters related to sylviculture or disturbance module (see code 1).

```{bash par, eval=FALSE, echo=TRUE}
##########################################################	
###  Sylviculture parameter file for the TROLL program ###	
##########################################################
###	GENERAL PARAMETERS
1	/* disturb_iter # iteration step where the disturbation occure */
###	disturbance
0.4	/* disturb_intensity # intensity of disturbance in percent of BA */
###	logging
30	/* designated_volume # volume designated for harvesting in m3/ha */
25	/* harvested_volume # volume harvested in m3/ha */
25	/* numespharvestable # number of harvestable species */	

###	Species
****	spnum	dbhmin	dbhmax	interest
Brosimum_guianense	7	0.55	2.0	1
Brosimum_rubescens	8	0.55	2.0	1
Caryocar_glabrum	12	0.55	2.0	1
Dicorynia_guianensis	35	0.55	2.0	1
Goupia_glabra	53	0.55	2.0	1
Manilkara_bidentata	81	0.55	2.0	1
Manilkara_huberi	82	0.55	2.0	1
Ocotea_argyrophylla	94	0.55	2.0	1
Qualea_rosea	130	0.55	2.0	1
Ruizterania_albiflora	134	0.55	2.0	1
Vouacapoua_americana	161	0.55	0.70	1
Couma_guianensis	29	0.55	2.0	2
Eperua_grandiflora	42	0.55	2.0	2
Lecythis_zabucajo	71	0.55	2.0	2
Moronobea_coccinea	90	0.55	2.0	2
Rhodostemonodaphne_grandis	133	0.55	2.0	2
Sterculia_pruriens	140	0.55	2.0	2
Sterculia_speciosa	141	0.55	2.0	2
Sterculia_villifera	142	0.55	2.0	2
Virola_michelii	159	0.55	2.0	2
Vochysia_guianensis	160	0.55	2.0	2
Bocoa_prouacensis	6	0.55	2.0	3
Couratari_multiflora	30	0.55	2.0	3
Eperua_falcata	41	0.55	2.0	3
Eperua_rubiginosa	43	0.55	2.0	3
```

Code 1: Example of Sylviculture parameter file for the TROLL program.

Following those data the model can calculate the total harvestable volume ${V_h}_{tot}$ and retains all trees id as **can be designated**. If ${V_h}_{tot} < 30*n_{ha}$, then all **can be designated** tree are considered as **designated**. If ${V_h}_{tot} > 30*n_{ha}$, then minimum harvestable diameter $dbh_{min}$ is increased untill ${V_h}_{tot} < 30*n_{ha}$, and finally all **can be designated** tree are considered as **designated** (see code 2).

```{rcpp designation, eval=FALSE, echo=TRUE}
/* DESIGNATION */
while(volume > designated_volume*1.05){
  volume=0.0;
  designated=0;
  for(site=0;site<sites;site++){
    if(T[site].t_age > 0 /*alive tree*/
&& S[T[site].t_sp_lab].s_harvestable  /*harvestable species*/
&& T[site].t_dbh >= S[T[site].t_sp_lab].s_dbhmin /*reached minimum dbh*/
&& T[site].t_dbh <= S[T[site].t_sp_lab].s_dbhmax){ /*under maximum dbh*/
status[site]=1;
      volume += -0.0358 + 8.7634*T[site].t_dbh*T[site].t_dbh; /*volume by ONF-2011 in French Guiana - Center (Kourou)*/
designated++;
    } else {
      status[site]=0;
    }
  }	
  if(volume > designated_volume){
    for(sp=1;sp<=numesp;sp++) {
      if(S[sp].s_harvestable){
        S[sp].s_dbhmin += 0.01;
      }
    }
  }
}
cout << designated << " trees have been designated, representing " << volume << " m3." << endl;
sp=1;
while(!S[sp].s_harvestable)
  sp++;
cout << S[sp].s_name << " dbh min is now " << S[sp].s_dbhmin << endl;
```

Code 2: Designation module.

## Selection

### Reality

Because the harvesters are focusing on few species with easier marketable wood for the moment (Angélique, Gonfolo, Grignon franc, Balata and few rares), about only 20 $m^3.ha^{-1}$ are harvested, and sometimes less, especially in the West forests of French Guiana. In addition to that, few rules are added for some species when designating trees (e.g. protecting no more than one Angélique and Gonfolo every 100 meters for seeding and only one Bagasse for two).

### Model

Thereafter we need to split **designated** trees between **selected** and **designated but not selected**. **Designated** trees kept by the harvester are linked to an additional data representing the species interest in external file (see code 1). Each harvestable species is ranked on its economic value. Then the model will kept only 25 $m^3.ha^{-1}$ inside designated trees by keeping only higher rank species.

```{rcpp selection, eval=FALSE, echo=TRUE}
/* SELECTION */
int rank=0, individuals=0;
if(volume <= harvested_volume)
  cout << "All designated trees will be harvested." << endl;
if(volume >= harvested_volume){
  for(site=0;site<sites;site++)
    if(status[site]==1 && S[T[site].t_sp_lab].s_interest > rank)
      rank = S[T[site].t_sp_lab].s_interest;
    while(volume >= harvested_volume){
      site=floor(genrand2()*sites);
      if(status[site]==1 && S[T[site].t_sp_lab].s_interest==rank){
        status[site]=0;
        individuals++;
        volume -= -0.0358 + 8.7634*T[site].t_dbh*T[site].t_dbh; /*volume by ONF-2011 in French Guiana - Center (Kourou)*/
      }
    }
    cout << individuals << " trees have been unselected, volume is now of " << volume << " m3." << endl;
}
```

Code 3: Selection module.

## Rotten

### Reality

20-30 percent of designated trees are considered as rotten once probed by the lumberman.

*NB: In fact only 50 percent of designated trees considered as rotten once probed by the lumber would be really entirely rotten. 50% of theim would be vital on 90% of the volume. Moreover if fuelwood economy is developped rotten tree could be used and the risk to cut a rotten tree could be taken (especially if 50% of theim are actually harvestable). But this fact only represent a perspective for the moment.*

### Model

Actually rotten trees are not random. We used rotten inventories from ONF to realize a model predictiong rotten trees volume from their species and diameter. First we seeked a model M to predict tree probability to be probed as rotten (see [probability to be rotten](rotten2.html)). Secondly we seeked a model N to predict final volume of wood in tree probed as rotten (see [final volume of wood](rotten3.html)). All results are summarised in [rotten document](rotten.html). Finally we implemented the model M: 
$$P_{rotten} = inv_{logit}(-5.151 + 0.042*dbh_{(cm)})$$
inside the `SelectiveLogging` module of TROLL model.

```{rcpp rotten, eval=FALSE, echo=TRUE}
/* ROTTEN */
float protten;
volume=0.0;
individuals=0;
for(site=0;site<sites;site++){
  if(status[site]==1){
    protten = 1 / (1 + exp(-(-5.151 + 0.042*T[site].t_dbh*100))); /*Probability to be rotten*/
if(genrand2() < protten){
  status[site]=0;
  individuals++;
  volume += -0.0358 + 8.7634*T[site].t_dbh*T[site].t_dbh; /*volume by ONF-2011 in French Guiana - Center (Kourou)*/
}
  }
}
cout << individuals << " trees are rotten, representing " << volume << " m3." << endl;
```

Code 4: Rotten module.

# Harvesting

Once designated we can proceed to logging and associated damages.

## Felling

### Reality

Main issue around the logging will be treefall direction. Due to crown aspects treefall is often considered as random. Whereas difficult to manage, treefall can still be oriented. In fact 4 orientations are available for treefall when logging (see figure 1). Oriented treefall idea is to get logs oriented at 45° two skidding ways to reduce damages when skidding. Currently few harvesters are applying this practice which is to be developed.

![figure 1. Treefall orientations when logging](treefall.png)

### Model

Whereas interessant to test, due to the fact it is not much applied in french guiana, I think we should not model oriented logging for the moment. We should consider logging treefall as random like current treefall implementation inside TROLL (see code 5).

```{rcpp felling, eval=FALSE, echo=TRUE}
/* LOGGING */
int individuals=0;
volume=0.0;
for(site=0;site<sites;site++){
  if(status[site]==1){
    row = floor(site/cols);
    col = site-(row*cols);
    output[36] << "L" << "\t" << col << "\t" << row << "\t" << T[site].t_age << "\t" << T[site].t_dbh << "\t" << T[site].t_Tree_Height << "\t" << T[site].t_Crown_Radius << "\t" << T[site].t_Crown_Depth << "\t" << T[site].t_sp_lab << endl;
    T[site].t_hurt += 10*T[site].t_Tree_Height;
    individuals ++;
    volume += -0.0358 + 8.7634*T[site].t_dbh*T[site].t_dbh; /*volume by ONF-2011 in French Guiana - Center (Kourou)*/
  }
}
cout << individuals << " trees have been logged representing " << volume << "m3." << endl;
```

Code 5: Felling module.

## Main track

### Reality

Roads are split in three classes: truck roads, main tractor track, and secondary track ('cloisonement'). Main skidtrails are used by skidding engines and follow crest model ; a function can calculate in advance their volume of transit by summing all pixels they serve and assuming 20 $m^3.ha^{-1}$. 

### Model

One more time, one major assumption of TROLL is a flat environment. Consequently the main track can be considered as a way starting from the middle of one side of the simulated forest and reaching the center (see code 6).

```{rcpp MT, eval=FALSE, echo=TRUE}
/* MAIN TRACK */
int MTindividuals=0;
int MT[sites];
for(site=0;site<sites;site++)
  MT[site] = 0;
for(row=0;row<(rows/2);row++){
  for(col=((cols/2)-7);col<((cols/2)+8);col++){
    site = col+row*cols;
    MT[site] = 1;
    if(T[site].t_age != 0) {
      output[36] << "MT" << "\t" << col << "\t" << row << "\t" << T[site].t_age << "\t" << T[site].t_dbh << "\t" << T[site].t_Tree_Height << "\t" << T[site].t_Crown_Radius << "\t" << T[site].t_Crown_Depth << "\t" << T[site].t_sp_lab << endl;
      T[site].Death();
      MTindividuals++;
    }
  }
}
cout << MTindividuals << " trees have been killed for the main track." << endl;
```

Code 6: Main track module.

## Secondary tracks (cloisonnement)

### Reality

Secondary tracks are computed once trees have been designated and the geolocation taken. Secondary track are all at a maximum distance of 30 meters from designated trees (because engine cables reach 50 meters but with an angle of 45°). Last thing taken into account is secondary track slope between track border ('devers') ; it need to be under 4%. Secondary tracks draw is half automatic but currently user is drawing the final pattern.

### Model

To not over-complicate the model we decided to simulate secondary tracks with few simple rules for a full automatic integration. It will not correspond to reality but because secondary tracks draw is a vast question (e.g. piste 2 and 3 softwares), it will answer or needs. The secondary tracks module compute the following algorithm (see code 7 and figure 2):

- Calculate a loads map measuring every trees at a distance of 30 meters for each pixel
- Calculate a track proximity maps of the closest existing track
- Select the pixel with the highest load and closest track
- Find the closest existing track and join it
- Trace the secondary track removing from list all felt trees in a radius of 30 meters from the track
- Repeat operations untill no felt trees are left

```{rcpp ST, eval=FALSE, echo=TRUE}
/* SECONDARY TRACK */
int load[sites], tracks[sites], ST[sites], STindividuals=0;
int site0, row0, col0, siteMT, rowMT, colMT;
float d, d0;
for(site=0;site<sites;site++){
  ST[site] = 0;
}
while(individuals > 0){
  for(site0=0;site0<sites;site0++){ /*loadings and tracks distance*/
load[site0]=0;
    tracks[site0]=rows*cols*rows*cols;
    row0 = floor(site0/cols);
    col0 = site0-(row0*cols);
    for(site=0;site<sites;site++){
      if(status[site]==1 || MT[site]==1){
        row = floor(site/cols);
        col = site-(row*cols);
        d = (row - row0)*(row - row0) + (col - col0)*(col - col0);
        if(status[site]==1 && d <= 30*30)
          load[site0]++;
        if(MT[site]==1 && d < tracks[site0])
          tracks[site0]=d;
      }
    }
  }
  site0=0;
  for(site=0;site<sites;site++){ /*best candidate*/
if(load[site]>load[site0])
  site0=site;
if(load[site]==load[site0] && tracks[site]<tracks[site0])
  site0=site;
  }	
  row0 = floor(site0/cols);
  col0 = site0-(row0*cols);
  d0 = rows*cols*rows*cols; /* closest MT*/
for(site=0;site<sites;site++){
  if(MT[site]==1){
    rowMT = floor(site/cols);
    colMT = site-(rowMT*cols);
    d = (row0 - rowMT)*(row0 - rowMT) + (col0 - colMT)*(col0 - colMT);
    if(d<d0){
      siteMT=site;
      d0=d;
    }
  }
}
rowMT = floor(siteMT/cols);
colMT = siteMT-(rowMT*cols);
do{ /*trace ST*/
do {
  for(int i=-2;i<=2;i++){ /*flag ST*/
for(int j=-2;j<=2;j++){
  site = (col0+i)+(row0+j)*cols;
  if(site>=0 && site<sites){
    ST[site]=1; 
    MT[site]=1;
  }
}
  }
  for(site=0;site<sites;site++){ /*unflag served trees*/
if(status[site]==1){
  row = floor(site/cols);
  col = site-(row*cols);
  d = (row - row0)*(row - row0) + (col - col0)*(col - col0);
  if(d <= 33*33){
    status[site]=0;
    individuals--;
  }
}
  }
  if(col0 > colMT)
    col0--;
  if(col0 < colMT)
    col0++;
  if(row0 > rowMT)
    row0--;
  if(row0 < rowMT)
    row0++;
} while(row0 != rowMT);
} while(col0 != colMT);
cout << "A secondary track have been traced." << endl;
}
for(site=0;site<sites;site++){ /*removing trees*/
if(ST[site]==1 && T[site].t_age != 0){
  row = (site/cols);
  col = site-(row*cols);
  output[36] << "ST" << "\t" << col << "\t" << row << "\t" << T[site].t_age << "\t" << T[site].t_dbh << "\t" << T[site].t_Tree_Height << "\t" << T[site].t_Crown_Radius << "\t" << T[site].t_Crown_Depth << "\t" << T[site].t_sp_lab << endl;
  T[site].Death();
  STindividuals ++;
}
}
cout << STindividuals << " trees have been killed for secondary tracks." << endl;
```

Code 7: Secondary tracks module.

```{r tracks}
test <- loadOutput('test', '~/Documents/ECOFOG/TROLL/inst/tools/test/')
dist <- test@disturbance
g <- ggplot(dist, aes(x = col, y = row, size = dbh, col = type, label = species)) + geom_point() + coord_fixed()
g
```

Figure 2. Tracks design inside TROLL.

## Skidding

### Reality

Last thing to take into account is skidding. When felt trees are removed from the plots they hurt and kill alive trees. One major thing is tree killed by rotation of the logs when tracted from the plot to the secondary track ("effet essuies glasses").

*NB: A perspective in skidding is the logs length for skidding. For time purposes, currently logs are skidded in one piece. But because damages are proportionnal to the square of the length of the logs it could be questionned. Effectively long logs have increased damages in curves during skidding.*

### Model

This part need to be implemented in sylviculture module.

## Other damages

### Reality

The Office Nationale des Forêts is realizing diagnostic of disturbance from harvesting (DPE). The question of increased mortality is also studied with GUYAFOR and TmFO plots. First results suggests that the time for the ecosystem to come back to its original death rate depend on the original death rate intensity. But this time seems lower thant the 10 years often used in simulations [@Huth2004; @Khler2004; @Ruger2008]. Last thing increased mortality seems localised around harvested areas (but even for not directly hurted trees).

### Modelling

Nevertheless, in addition to trees killed or hurted by treefall, roads and skidding explicitly modelled, it seems that we need to take into account an implicit extra mortality. This increased mortality following harvesting is decreasing in time untill null. It could be fitted on Paracou and Guyafor data.

This part need to be implemented in sylviculture module.

# Conclusion

## Paracou

Paracou harvesting effectively represents more volume than current logging in french guiana. Still damages are similar to what we can have now. Consequently it appears as a correct site to fit different parameters for the model.

## Model

We can summarize modelling of selective logging in few steps :

- Trees choice
    - *Harvestable areas*: the whole simulated forest
    - Designation: all trees meeting species minimum and maximum harvestable diameters under or equal to a total volume of 30 $m^3.ha^{-1}$
    - Selection: first ranked trees according to harvesters reaching a total volume of 25 $m^3.ha^{-1}$
    - Rotten: selected trees less 20-30% of selected trees considered as rotten
- Harvesting
    - Felling: all selected trees
    - Main track: from the middle of one side of the simulated forest to the center
    - Secondary track (cloisonnement): following our own simplified algorithm
    - Skidding: to be implemented
    - Other damages: to be implemented
    
## Perspectives

Current slective logging in french guiana encompass different perspective to evolve. Some are summarized here:

- Diversification: harvesting more species (harvesters select species with higher economical interest) to reach 25 $m^3.ha^{-1}$
- Oriented treefall: see section about logging
- Logs length for skidding: see section about roads and skidding
- Thinning: remove trees to increase growth grom trees of interest
- Decreasing the maximum distance of skid trail from felled trees from 30 to 20 m, which will result in an increase in the skid trails network, in the fuelwood harvest and a decrease of the skidding costs

## Internship question

One major advantage of TROLL model compare to other simulators spatially-explicits and individual-based (e.g. FORMIND and SORTIE) is the use of species and not of plant functionnal types (PFT). In that way, TROLL outperform other simulators to simulates biodiversity and its related effects. This is the reason why I think I could use the implementation of the sylviculture module inside TROLL to study the perspective of diversification. 

*In which order reducing damages on global diversity by increasing harvesting diversity will affect forest ecosystem answer to the distruabnce brought by selective logging ?*

# References
